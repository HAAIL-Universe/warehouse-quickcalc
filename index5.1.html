<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Warehouse QuickCalc & Tracker</title>
<style>
:root { --bg:#0b0d10; --card:#141821; --ink:#e8eef7; --muted:#9fb3c8; --accent:#2f6bff; --line:#243244; --ok:#1b6e36; --warn:#8a6a15; --bad:#7a2b2b; }
* { box-sizing: border-box; }
html,body { margin:0; padding:0; background:#0b0d10; color:var(--ink); font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
.wrap { max-width: 980px; margin: 0 auto; padding: 14px; }
h1 { font-size: 20px; margin:6px 0 10px; }
.tabs { display:flex; gap:8px; margin:6px 0 10px; position: sticky; top:0; background:#0b0d10; padding-top:6px; z-index:5; }
.tabbtn { flex:1; text-align:center; padding:10px; border:1px solid #253348; border-radius:10px; background:#0f131b; color:var(--ink); font-weight:700; cursor:pointer; }
.tabbtn.active { border-color: var(--accent); box-shadow: inset 0 0 0 1px var(--accent); }
.hidden { display:none; }
.card { background:var(--card); border:1px solid #253348; border-radius:14px; padding:14px; margin: 10px 0; }
label { display:block; font-size:12px; color:#9fb3c8; margin-bottom:4px; }
input, select, button { font-size:16px; }
input[type="number"], input[type="time"], input[type="text"], select {
  width:100%; background:#0f131b; color:var(--ink); border:1px solid #29364a; border-radius:10px; padding:10px; outline:none;
}
.row { display:flex; gap:10px; flex-wrap: wrap; }
.col { flex:1; min-width:220px; }
.btn { padding:10px 12px; border-radius:10px; border:1px solid #32507a; background:#1a2a40; color:var(--ink); font-weight:700; cursor:pointer; }
.btn.ghost { background:transparent; border-color:#29364a; }
.btn.ok { border-color:#2e6b3a; background:#173220; }
.btn.warn { border-color:#8a6a15; background:#30250f; }
.btn.bad { border-color:#7a2b2b; background:#331b1b; }
.btn.chip { padding:8px 10px; border-radius:999px; }
.btn.slim { padding:6px 10px; border-radius:999px; font-size:14px; }
.pill { border-radius:12px; padding:10px 12px; background:#0f131b; border:1px solid #29364a; text-align:center; }
.pill h3 { margin:0; font-size:13px; color:#9fb3c8; }
.pill p { margin:6px 0 0; font-size:22px; font-weight:800; }
.rateBanner { position: sticky; top:48px; z-index:4; display:flex; gap:10px; margin:8px 0; }
.rateChip { flex:1; text-align:center; padding:10px; border-radius:10px; border:1px solid #29364a; background:#0f131b; }
.rateChip.good { border-color:#1f4830; background:#14271c; }
.rateChip.warn { border-color:#584a1a; background:#2a230f; }
.rateChip.bad { border-color:#4f1f1f; background:#2a1313; }
.timeline { margin-top:8px; border-left:2px solid #29364a; padding-left:10px; }
.tick { margin:6px 0; color:#cfe2ff; font-size:13px; display:flex; align-items:center; gap:8px; justify-content:space-between; }
.tick .meta { color:#9fb3c8; font-size:12px; }
table { width:100%; border-collapse:collapse; font-size:14px; }
th, td { border-bottom:1px dashed #253348; padding:8px 6px; text-align:left; }
th { color:#9fb3c8; }
.bottom-actions { margin: 20px 0 40px; display:flex; justify-content:flex-end; }
.hint { color:#9fb3c8; font-size:12px; }
.small { font-size:12px; color:#9fb3c8; }
.sectionHead { display:flex; align-items:center; justify-content:space-between; gap:8px; }
</style>
</head>
<body>
<div class="wrap">
  <h1>Warehouse QuickCalc & Tracker</h1>

  <div class="tabs">
    <button id="tabCalcBtn" class="tabbtn active" onclick="showTab('calc')">QuickCalc</button>
    <button id="tabTrackBtn" class="tabbtn" onclick="showTab('tracker')">Tracker</button>
    <button id="tabHistBtn" class="tabbtn" onclick="showTab('history')">History</button>
  </div>

  <div id="liveBanner" class="rateBanner hidden">
    <div id="chipRate" class="rateChip"><b>Live Rate</b><div id="chipRateVal">—</div></div>
    <div id="chipTotal" class="rateChip"><b>Total Units</b><div id="chipTotalVal">0</div></div>
    <div id="chipGap" class="rateChip"><b>Gap vs 300</b><div id="chipGapVal">—</div></div>
  </div>

  <!-- QuickCalc -->
  <section id="tabCalc">
    <div class="card">
      <div class="row">
        <div class="col">
          <label>Customer</label>
          <div class="row" style="gap:6px;">
            <div class="col">
              <select id="qcCustomer">
                <option value="TESWIN">TESWIN</option>
<option value="SAINOR">SAINOR</option>
<option value="SAIEME">SAIEME</option>
<option value="WAILEY">WAILEY</option>
<option value="ASDERI">ASDERI</option>
<option value="COOWES">COOWES</option>
<option value="COOAVO">COOAVO</option>
<option value="COOWEL">COOWEL</option>
                <option value="__OTHER__">Other…</option>
              </select>
            </div>
            <div class="col">
              <input id="qcOther" type="text" class="hidden" maxlength="6" placeholder="ABCDEF">
            </div>
          </div>
        </div>
        <div class="col">
          <label>Units</label>
          <input id="qcUnits" type="number" min="1" step="1" inputmode="numeric" placeholder="e.g. 820">
        </div>
        <div class="col">
          <label>Override Rate (u/h)</label>
          <input id="qcRate" type="number" min="1" step="1" inputmode="numeric" placeholder="optional">
        </div>
      </div>
      <div style="height:6px"></div>
      <div class="pill"><h3>Expected Pallets & Duration</h3><p id="qcCombo">—</p><div id="qcRateUsed" class="small">—</div></div>
    </div>
  </section>

  <!-- Tracker -->
  <section id="tabTracker" class="hidden">
    <div class="card" id="shiftCard">
      <div class="row">
        <div class="col">
          <label>Shift Start (HH:MM)</label>
          <div class="row" style="gap:6px;">
            <div class="col"><input id="tStart" type="time" placeholder="08:00"></div>
            <div class="col" style="max-width:140px;"><button class="btn chip" onclick="setNow('tStart')">Now</button></div>
          </div>
          <div id="snapHint" class="hint"></div>
        </div>
        <div class="col">
          <label>Shift Length (hours)</label>
          <input id="tLen" type="number" min="1" step="0.5" value="9">
        </div>
        <div class="col" style="align-self:end; text-align:right;">
          <button class="btn ok" onclick="beginShift()" id="btnBegin" style="min-width:180px;">Begin Tracking</button>
        </div>
      </div>
      <div class="hint">Daily avg uses full shift length. Live rate uses Start → last Wrap/Close (or now if order active).</div>
    </div>

    <div class="card" id="activeOrderCard" style="display:none;">
      <div class="sectionHead">
        <h3 style="margin:0; font-size:14px; color:#9fb3c8;">Active Order</h3>
        <button id="btnManualToggle" class="btn ghost" onclick="toggleManual()">Add Manual Order</button>
      </div>
      <div class="row" style="align-items:flex-end;">
        <div class="col">
          <label>Customer</label>
          <div class="row" style="gap:6px;">
            <div class="col">
              <select id="oCust">
                <option value="TESWIN">TESWIN</option>
<option value="SAINOR">SAINOR</option>
<option value="SAIEME">SAIEME</option>
<option value="WAILEY">WAILEY</option>
<option value="ASDERI">ASDERI</option>
<option value="COOWES">COOWES</option>
<option value="COOAVO">COOAVO</option>
<option value="COOWEL">COOWEL</option>
                <option value="__OTHER__">Other…</option>
              </select>
            </div>
            <div class="col">
              <input id="oOther" type="text" class="hidden" maxlength="6" placeholder="ABCDEF">
            </div>
          </div>
        </div>
        <div class="col">
          <label>Total units</label>
          <input id="oTotal" type="number" min="0" step="1" inputmode="numeric" placeholder="e.g. 1024">
        </div>
        <div class="col" style="display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;">
          <button id="btnUndo" class="btn slim" onclick="undoLast()" style="display:none;">Undo</button>
          <span style="flex:1"></span>
          <button id="btnB" class="btn chip" title="20 min break" onclick="addBreak('B')" style="display:none;">B</button>
          <button id="btnL" class="btn chip" title="30 min lunch" onclick="addBreak('L')" style="display:none;">L</button>
          <button class="btn" onclick="startOrder()" id="btnStart">Start</button>
          <button class="btn ok" onclick="completeOrder()" id="btnComplete" style="display:none;">Complete</button>
        </div>
      </div>

      <div id="orderArea" style="display:none; margin-top:10px;">
        <div class="row">
          <div class="col">
            <label>Units left (log wrap)</label>
            <input id="oLeft" type="number" min="0" step="1" inputmode="numeric" placeholder="e.g. 413">
          </div>
          <div class="col">
            <label id="manualLbl" class="hidden">Manual time (HH:MM)</label>
            <div class="row" style="gap:6px;">
              <div class="col"><input id="oManualTime" class="hidden" type="time" placeholder="12:34"></div>
              <div class="col" style="max-width:160px;"><button class="btn" onclick="logWrap()">Log Wrap</button></div>
            </div>
          </div>
        </div>

        <div class="timeline" id="orderTimeline"></div>
      </div>

      <!-- Manual order editor -->
      <div id="manualBox" class="card" style="display:none; margin-top:12px; background:#10141c;">
        <div class="row">
          <div class="col">
            <label>Customer</label>
            <div class="row" style="gap:6px;">
              <div class="col">
                <select id="mCust">
                  <option value="TESWIN">TESWIN</option>
<option value="SAINOR">SAINOR</option>
<option value="SAIEME">SAIEME</option>
<option value="WAILEY">WAILEY</option>
<option value="ASDERI">ASDERI</option>
<option value="COOWES">COOWES</option>
<option value="COOAVO">COOAVO</option>
<option value="COOWEL">COOWEL</option>
                  <option value="__OTHER__">Other…</option>
                </select>
              </div>
              <div class="col">
                <input id="mOther" type="text" class="hidden" maxlength="6" placeholder="ABCDEF">
              </div>
            </div>
          </div>
          <div class="col"><label>Units</label><input id="mUnits" type="number" min="1" step="1"></div>
          <div class="col"><label>Pallets (optional)</label><input id="mPallets" type="number" min="1" step="1"></div>
        </div>
        <div class="row">
          <div class="col"><label>Start (HH:MM)</label><input id="mStart" type="time"></div>
          <div class="col"><label>End (HH:MM)</label><input id="mEnd" type="time"></div>
          <div class="col"><label>Excl. mins (B/L)</label><input id="mExcl" type="number" min="0" step="1" placeholder="0"></div>
          <div class="col" style="align-self:end; text-align:right;"><button class="btn ok" onclick="addManual()">Add Manual Order</button></div>
        </div>
        <div class="hint">Use this to backfill missed orders. Rate = Units ÷ ((End−Start) − Excl/60).</div>
      </div>
    </div>

    <div class="card" id="completedCard" style="display:none;">
      <h3 style="margin:0 0 8px; font-size:14px; color:#9fb3c8;">Completed Orders</h3>
      <table>
        <thead><tr><th>#</th><th>Customer</th><th>Units</th><th>Pallets</th><th>Start</th><th>Closed</th><th>Order Rate (excl. B/L)</th></tr></thead>
        <tbody id="doneBody"></tbody>
      </table>
    </div>

    <div class="card" id="summaryCard" style="display:none;">
      <div class="row" style="gap:10px;">
        <div class="pill" style="flex:1"><h3>Total Units</h3><p id="sumUnits">0</p></div>
        <div class="pill" style="flex:1"><h3>Live Rate</h3><p id="liveRate">0</p></div>
        <div class="pill" style="flex:1"><h3>Daily Avg</h3><p id="dayRate">0</p><div class="small">units ÷ full shift</div></div>
        <div class="pill" style="flex:1"><h3>Gap vs 300</h3><p id="gap300">—</p></div>
      </div>
    </div>

    <div class="bottom-actions">
      <button class="btn ok" id="btnEndShift" onclick="endShift()" style="display:none; min-width:220px;">End Shift & Archive →</button>
    </div>
  </section>

  <!-- History -->
  <section id="tabHistory" class="hidden">
    <div class="card">
      <div style="display:flex; gap:8px; justify-content:space-between; align-items:center; flex-wrap:wrap;">
        <h3 style="margin:0; font-size:14px; color:#9fb3c8;">History (daily archives)</h3>
        <div>
          <button class="btn gate-share" onclick="exportCSV()">Export CSV (today)</button>
          <button class="btn gate-share" onclick="exportJSON()">Export JSON (all)</button>
          <label id="impLabel" class="btn gate-import hidden" for="impFile">Import JSON</label><input id="impFile" type="file" accept="application/json" style="display:none;">
          <button class="btn" style="background:#331b1b;border-color:#7a2b2b;" onclick="clearHistory()">Clear History</button>
          <button class="btn gate-share" onclick="toggleManageCustomers()">Manage Customers</button>
        </div>
      </div>
      <div id="histList" style="margin-top:8px;"></div>
    </div>
  </section>
</div>

<script>
const STORE_KEY = 'wqt_store_v1';
const DEFAULT_CODES = ['TESWIN','SAINOR','SAIEME','WAILEY','ASDERI','COOWES','COOAVO','COOWEL'];

let picks=[], tempWraps=[], current=null, startTime='', lastClose='', historyDays=[], customCodes=[];

function saveAll(){ try{ localStorage.setItem(STORE_KEY, JSON.stringify({picks, startTime, lastClose, history:historyDays, customCodes})); }catch(e){} }
function loadAll(){ try{ var raw=localStorage.getItem(STORE_KEY); if(raw){ var p=JSON.parse(raw); picks=p.picks||[]; startTime=p.startTime||''; lastClose=p.lastClose||''; historyDays=p.history||[]; customCodes=p.customCodes||[]; } }catch(e){} }

function showTab(which){
  ['tabCalc','tabTracker','tabHistory'].forEach(id=>document.getElementById(id).classList.toggle('hidden', id!=='tab'+which.charAt(0).toUpperCase()+which.slice(1)));
  ['tabCalcBtn','tabTrackBtn','tabHistBtn'].forEach(id=>document.getElementById(id).classList.remove('active'));
  if(which==='calc') document.getElementById('tabCalcBtn').classList.add('active');
  if(which==='tracker') document.getElementById('tabTrackBtn').classList.add('active');
  if(which==='history') document.getElementById('tabHistBtn').classList.add('active');
  document.getElementById('liveBanner').classList.toggle('hidden', which!=='tracker');
  updateEndShiftVisibility();
}

function setNow(id){ var el=document.getElementById(id); var d=new Date(); var v=String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0'); if(id==='tStart'){ el.value=v; startTime=v; saveAll(); } else { el.value=v; } updateSummary(); }

function beginShift(){ var typed=document.getElementById('tStart').value; if(typed) startTime=typed; document.getElementById('shiftCard').style.display='none'; document.getElementById('activeOrderCard').style.display='block'; document.getElementById('summaryCard').style.display='block'; document.getElementById('completedCard').style.display='block'; renderDone(); updateSummary(); updateEndShiftVisibility(); saveAll(); }

function addManual(){
  var sel=document.getElementById('mCust'); var name=sel.value;
  if(name==='__OTHER__'){ var s=document.getElementById('mOther').value; if(!/^[A-Za-z]{6}$/.test(s)) return alert('Enter 6 letters'); name=s.toUpperCase(); }
  var units=parseInt(document.getElementById('mUnits').value||'0',10);
  var pallets=parseInt(document.getElementById('mPallets').value||'0',10)||1;
  var start=document.getElementById('mStart').value;
  var close=document.getElementById('mEnd').value;
  var excl=parseInt(document.getElementById('mExcl').value||'0',10);
  if(!name || units<=0 || !start || !close) return alert('Customer, units, start and end are required');
  picks.push({name, units, pallets, start, close, excl});
  lastClose=close; renderDone(); updateSummary(); saveAll(); alert('Manual order added');
}

function toggleManual(){ var box=document.getElementById('manualBox'); box.style.display = (box.style.display==='none' || box.style.display==='') ? 'block':'none'; }

function hm(str){ if(!str) return NaN; var a=str.split(':'), H=parseInt(a[0],10), M=parseInt(a[1],10); if(isNaN(H)||isNaN(M)) return NaN; return H + M/60; }
function rateFrom(o){ var s=hm(o.start), e=hm(o.close); var net=(e>s)?(e-s)-(o.excl||0)/60:0.01; return Math.round(o.units/Math.max(0.01,net)); }

function renderDone(){ var tb=document.getElementById('doneBody'); tb.innerHTML=''; picks.forEach(function(o,i){ tb.innerHTML+='<tr><td>'+(i+1)+'</td><td>'+o.name+'</td><td>'+o.units+'</td><td>'+o.pallets+'</td><td>'+o.start+'</td><td>'+o.close+'</td><td>'+rateFrom(o)+' u/h</td></tr>'; }); document.getElementById('completedCard').style.display = picks.length? 'block':'none'; }

function lastEvent(){ return lastClose || ''; }
function updateSummary(){ var closedUnits=picks.reduce((a,b)=>a+b.units,0); var s=hm(startTime), e=hm(lastEvent()); var live=(!isNaN(s)&&!isNaN(e)&&e>s)? Math.round(closedUnits/(e-s)) : 0; var shiftLen=parseFloat(document.getElementById('tLen').value||'9'); var dayAvg=shiftLen>0? Math.round(closedUnits/shiftLen):0; document.getElementById('sumUnits').textContent=closedUnits; document.getElementById('liveRate').textContent=live; document.getElementById('dayRate').textContent=dayAvg; document.getElementById('gap300').textContent=(300-dayAvg)+' u/h'; document.getElementById('chipRateVal').textContent=live? (live+' u/h'):'—'; document.getElementById('chipTotalVal').textContent=closedUnits; document.getElementById('chipGapVal').textContent=(300-dayAvg); }

function updateEndShiftVisibility(){ var btn=document.getElementById('btnEndShift'); var trackerVisible=!document.getElementById('tabTracker').classList.contains('hidden'); btn.style.display=(trackerVisible && picks.length>0)?'inline-block':'none'; }

function endShift(){ if(!picks.length) return alert('No orders to archive.'); var dateStr=(new Date()).toISOString().slice(0,10); var shiftLen=parseFloat(document.getElementById('tLen').value||'9'); var totalUnits=picks.reduce((a,b)=>a+b.units,0); var tS=hm(startTime), tE=hm(lastEvent()); var liveRate=(!isNaN(tS)&&!isNaN(tE)&&tE>tS)?Math.round(totalUnits/(tE-tS)):0; var dayRate=shiftLen>0?Math.round(totalUnits/shiftLen):0; var snapshot={date:dateStr,start:startTime||'',end:lastEvent()||'',shiftLen,totalUnits,liveRate,dayRate,picks:picks.slice(0)}; historyDays.push(snapshot); saveAll(); renderHistory(); picks=[]; lastClose=''; document.getElementById('completedCard').style.display='none'; updateSummary(); showTab('history'); updateEndShiftVisibility(); saveAll(); }

function renderHistory(){ var host=document.getElementById('histList'); host.innerHTML=''; if(!historyDays.length){ host.innerHTML='<div class="hint">No archived days yet.</div>'; return; } historyDays.slice(0).reverse().forEach(function(d){ var table='<table><thead><tr><th>#</th><th>Customer</th><th>Units</th><th>Pallets</th><th>Start</th><th>Closed</th><th>Order Rate</th></tr></thead><tbody>'; (d.picks||[]).forEach(function(o,i){ table+='<tr><td>'+(i+1)+'</td><td>'+o.name+'</td><td>'+o.units+'</td><td>'+o.pallets+'</td><td>'+o.start+'</td><td>'+o.close+'</td><td>'+rateFrom(o)+' u/h</td></tr>'; }); table+='</tbody></table>'; var div=document.createElement('div'); div.className='card'; div.innerHTML='<div class="sectionHead"><b>'+d.date+'</b><span>Units: '+d.totalUnits+' • Day Avg: '+d.dayRate+' u/h • Live: '+d.liveRate+' u/h</span></div>'+table; host.appendChild(div); }); }

function clearHistory(){ if(!confirm('Clear ALL archived days?')) return; historyDays=[]; saveAll(); renderHistory(); }

// Boot
document.addEventListener('DOMContentLoaded', function(){
  // populate dropdowns
  function opts(){ return DEFAULT_CODES.map(c=>'<option value="'+c+'">'+c+'</option>').join(''); }
  document.getElementById('qcCustomer').innerHTML = opts() + '<option value="__OTHER__">Other…</option>';
  document.getElementById('oCust').innerHTML = opts() + '<option value="__OTHER__">Other…</option>';
  document.getElementById('mCust').innerHTML = opts() + '<option value="__OTHER__">Other…</option>';

  loadAll(); renderHistory(); renderDone(); updateSummary();
  if(picks.length>0 || startTime){ showTab('tracker'); document.getElementById('shiftCard').style.display = startTime? 'none':'block'; document.getElementById('summaryCard').style.display='block'; document.getElementById('activeOrderCard').style.display='block'; if(picks.length) document.getElementById('completedCard').style.display='block'; }
});
</script>
</body>
</html>
