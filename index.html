
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>QuickCalc + Tracker v2.7.5</title>
<style>
  :root { --bg:#0b0d10; --card:#141821; --ink:#e8eef7; --muted:#9fb3c8; --accent:#2f6bff; --line:#243244; --ok:#1b6e36; --warn:#8a6a15; --bad:#7a2b2b; }
  * { box-sizing: border-box; }
  html, body { margin:0; padding:0; background:#0b0d10; color:#e8eef7; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  .wrap { max-width: 980px; margin: 0 auto; padding: 14px; }
  h1 { font-size: 20px; margin:0 0 8px; }
  .sub { color:var(--muted); font-size:12px; margin-left:6px; }
  .tabs { display:flex; gap:8px; margin:10px 0; position: sticky; top:0; background:#0b0d10; padding-top:8px; z-index:5; }
  .tabbtn { flex:1; text-align:center; padding:10px; border:1px solid #253348; border-radius:10px; background:#0f131b; color:#e8eef7; font-weight:700; }
  .tabbtn.active { border-color: var(--accent); box-shadow: inset 0 0 0 1px var(--accent); }
  .hidden { display:none; }
  .card { background:#141821; border:1px solid #253348; border-radius:14px; padding:14px; margin: 10px 0; }
  label { display:block; font-size:12px; color:#9fb3c8; margin-bottom:4px; }
  input, select, button { font-size:16px; }
  input[type="number"], input[type="time"], input[type="text"], select {
    width:100%; background:#0f131b; color:#e8eef7; border:1px solid #29364a; border-radius:10px; padding:10px; outline:none;
  }
  .row { display:flex; gap:10px; flex-wrap: wrap; }
  .col { flex:1; min-width:220px; }
  .btn { padding:10px 12px; border-radius:10px; border:1px solid #32507a; background:#1a2a40; color:#e8eef7; font-weight:700; cursor:pointer; }
  .btn.ok { border-color:#2e6b3a; background:#173220; }
  .btn.chip { padding:8px 10px; border-radius:999px; }
  .pill { border-radius:12px; padding:10px 12px; background:#0f131b; border:1px solid #29364a; text-align:center; }
  .pill h3 { margin:0; font-size:13px; color:#9fb3c8; }
  .pill p { margin:6px 0 0; font-size:22px; font-weight:800; }
  .summarygrid { display:grid; grid-template-columns: repeat(2, minmax(160px,1fr)); gap:10px; }
  .rateBanner { position: sticky; top:48px; z-index:4; display:flex; gap:10px; margin:8px 0; }
  .rateChip { flex:1; text-align:center; padding:10px; border-radius:10px; border:1px solid #29364a; background:#0f131b; }
  .rateChip.good { border-color:#1f4830; background:#14271c; }
  .rateChip.warn { border-color:#584a1a; background:#2a230f; }
  .rateChip.bad { border-color:#4f1f1f; background:#2a1313; }
  .timeline { margin-top:8px; border-left:2px solid #29364a; padding-left:10px; }
  .tick { margin:6px 0; color:#cfe2ff; font-size:13px; display:flex; align-items:center; gap:8px; justify-content:space-between; }
  .tick .meta { color:#9fb3c8; font-size:12px; }
  table { width:100%; border-collapse:collapse; font-size:14px; }
  th, td { border-bottom:1px dashed #253348; padding:8px 6px; text-align:left; }
  th { color:#9fb3c8; }
  .bottom-actions { margin: 20px 0 40px; display:flex; justify-content:flex-end; }
  .inline { display:flex; gap:8px; align-items:end; }
</style>
</head>
<body>
<div class="wrap">
  <h1>Warehouse QuickCalc & Tracker <span class="sub">v2.7.5 · 2025-10-24 22:58 UTC</span></h1>

  <div class="tabs">
    <button id="tabCalcBtn" class="tabbtn active" onclick="showTab('calc')">QuickCalc</button>
    <button id="tabTrackBtn" class="tabbtn" onclick="showTab('tracker')">Tracker</button>
    <button id="tabHistBtn" class="tabbtn" onclick="showTab('history')">History</button>
  </div>

  <div id="liveBanner" class="rateBanner hidden">
    <div id="chipRate" class="rateChip"><b>Live Rate</b><div id="chipRateVal">—</div></div>
    <div id="chipTotal" class="rateChip"><b>Total Units</b><div id="chipTotalVal">0</div></div>
    <div id="chipGap" class="rateChip"><b>Gap vs 300</b><div id="chipGapVal">—</div></div>
  </div>

  <!-- QuickCalc -->
  <section id="tabCalc">
    <div class="card">
      <div class="row">
        <div class="col">
          <label>Customer</label>
          <div class="inline">
            <select id="qcCustomer">
              <option value="TESWIN">TESWIN</option>
<option value="SAINOR">SAINOR</option>
<option value="SAIEME">SAIEME</option>
<option value="WAILEY">WAILEY</option>
<option value="ASDERI">ASDERI</option>
<option value="COOWES">COOWES</option>
<option value="COOAVO">COOAVO</option>
<option value="COOWEL">COOWEL</option>
              <option value="__OTHER__">Other…</option>
            </select>
            <input id="qcOther" type="text" class="hidden" maxlength="6" placeholder="ABCDEF" pattern="[A-Za-z]{6}" style="max-width:140px;">
          </div>
          <div id="qcOtherHint" class="hidden" style="color:#9fb3c8;font-size:12px;">Enter 6 letters (A–Z). We’ll add it to your list.</div>
        </div>
        <div class="col">
          <label>Units</label>
          <input id="qcUnits" type="number" min="1" step="1" inputmode="numeric" placeholder="e.g. 820">
        </div>
        <div class="col">
          <label>Override Rate (u/h)</label>
          <input id="qcRate" type="number" min="1" step="1" inputmode="numeric" placeholder="optional">
        </div>
      </div>
      <div style="height:6px"></div>
      <div class="summarygrid">
        <div class="pill"><h3>Expected Pallets</h3><p id="qcPallets">—</p></div>
        <div class="pill"><h3>Expected Duration</h3><p id="qcDur">—</p><div id="qcRateUsed" class="small">—</div></div>
      </div>
    </div>
  </section>

  <!-- Tracker -->
  <section id="tabTracker" class="hidden">
    <div class="card" id="shiftCard">
      <div class="row">
        <div class="col">
          <label>Shift Start (HH:MM)</label>
          <div class="inline">
            <input id="tStart" type="time" placeholder="08:00">
            <button class="btn chip" onclick="setNow('tStart')">Now</button>
          </div>
          <div id="snapHint" class="hint"></div>
        </div>
        <div class="col">
          <label>Shift Length (hours)</label>
          <input id="tLen" type="number" min="1" step="0.5" value="9">
        </div>
        <div class="col" style="align-self:end; text-align:right;">
          <button class="btn ok" onclick="beginShift()" id="btnBegin" style="min-width:180px;">Begin Tracking</button>
        </div>
      </div>
      <div class="hint">Daily avg uses full shift length. Live rate uses Start → last Order Close.</div>
    </div>

    <div class="card" id="activeOrderCard" style="display:none;">
      <div class="row" style="align-items:flex-end;">
        <div class="col">
          <label>Customer</label>
          <div class="inline">
            <select id="oCust">
              <option value="TESWIN">TESWIN</option>
<option value="SAINOR">SAINOR</option>
<option value="SAIEME">SAIEME</option>
<option value="WAILEY">WAILEY</option>
<option value="ASDERI">ASDERI</option>
<option value="COOWES">COOWES</option>
<option value="COOAVO">COOAVO</option>
<option value="COOWEL">COOWEL</option>
              <option value="__OTHER__">Other…</option>
            </select>
            <input id="oOther" type="text" class="hidden" maxlength="6" placeholder="ABCDEF" pattern="[A-Za-z]{6}" style="max-width:140px;">
          </div>
        </div>
        <div class="col">
          <label>Total units</label>
          <input id="oTotal" type="number" min="0" step="1" inputmode="numeric" placeholder="e.g. 1024">
        </div>
        <div class="col" style="display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;">
          <button id="btnUndo" class="btn slim" onclick="undoLast()" style="display:none;">Undo</button>
          <span style="flex:1"></span>
          <button id="btnB" class="btn chip" title="20 min break" onclick="addBreak('B')" style="display:none;">B</button>
          <button id="btnL" class="btn chip" title="30 min lunch" onclick="addBreak('L')" style="display:none;">L</button>
          <button class="btn" onclick="startOrder()" id="btnStart">Start</button>
          <button class="btn ok" onclick="completeOrder()" id="btnComplete" style="display:none;">Complete</button>
        </div>
      </div>

      <div id="manualPanel" class="card" style="display:none; background:#101521; border-color:#2a3a52; margin-top:10px;">
        <div class="row">
          <div class="col">
            <label>Manual Start (HH:MM)</label>
            <div class="inline">
              <input id="mStart" type="time" placeholder="08:00">
              <button class="btn" onclick="applyManualStart()">Apply Start</button>
            </div>
          </div>
          <div class="col">
            <label>Manual Close (HH:MM)</label>
            <div class="inline">
              <input id="mClose" type="time" placeholder="16:54">
              <button class="btn" onclick="applyManualClose()">Apply Close</button>
            </div>
          </div>
        </div>
      </div>

      <div id="orderArea" style="display:none; margin-top:10px;">
        <div class="row">
          <div class="col">
            <label>Units left (log wrap)</label>
            <input id="oLeft" type="number" min="0" step="1" inputmode="numeric" placeholder="e.g. 413">
          </div>
          <div class="col" style="align-self:end;">
            <button class="btn" onclick="logWrap()">Log Wrap</button>
          </div>
        </div>
        <div class="timeline" id="orderTimeline"></div>
      </div>
    </div>

    <div class="card" id="completedCard" style="display:none;">
      <h3 style="margin:0 0 8px; font-size:14px; color:#9fb3c8;">Completed Orders</h3>
      <table>
        <thead><tr><th>#</th><th>Customer</th><th>Units</th><th>Pallets</th><th>Closed</th><th>Order Rate (excl. B/L)</th></tr></thead>
        <tbody id="doneBody"></tbody>
      </table>
    </div>

    <div class="card" id="summaryCard" style="display:none;">
      <div class="summarygrid">
        <div class="pill"><h3>Total Units</h3><p id="sumUnits">0</p></div>
        <div class="pill"><h3>Live Rate</h3><p id="liveRate">0</p><div class="small" id="liveWindow">—</div><div class="small" id="learnedNote">—</div></div>
        <div class="pill"><h3>Daily Avg</h3><p id="dayRate">0</p><div class="small">units ÷ full shift</div></div>
        <div class="pill"><h3>Gap vs 300</h3><p id="gap300">—</p></div>
      </div>
    </div>

    <div class="bottom-actions">
      <button class="btn ok" id="btnEndShift" onclick="endShift()" style="display:none; min-width:220px;">End Shift & Archive →</button>
    </div>
  </section>

  <!-- History -->
  <section id="tabHistory" class="hidden">
    <div class="card">
      <div style="display:flex; gap:8px; justify-content:space-between; align-items:center; flex-wrap:wrap;">
        <h3 style="margin:0; font-size:14px; color:#9fb3c8;">History (daily archives)</h3>
        <div>
          <button class="btn gate-share" onclick="exportCSV()">Export CSV (today)</button>
          <button class="btn gate-share" onclick="exportJSON()">Export JSON (all)</button>
          <label class="btn gate-share" for="impFile">Import JSON</label><input id="impFile" type="file" accept="application/json" style="display:none;">
          <button class="btn" style="background:#331b1b;border-color:#7a2b2b;" onclick="clearHistory()">Clear History</button>
        </div>
      </div>
      <div id="histList" style="margin-top:8px;"></div>
    </div>
  </section>

  <div class="footer">v2.7.5: Fix “Other…” customer input (robust listeners) + persist custom codes.</div>
</div>

<div id="toast" class="toast">Saved</div>

<script>
let picks = [];         
let tempWraps = [];     
let current = null;     
let startTime = "";     
let lastClose = "";     
let undoStack = [];     
let learned = {};       
let historyDays = [];   
let customCodes = [];   // persist user-added customer codes

const KEY = 'wqt_v275';
const KEY_CODES = 'wqt_codes';
const SHARE_UNLOCK_CODE = '999'; 
let shareUnlocked = false;
let manualCloseTime = "";

var defaultRate = {TESWIN:404,SAINOR:262,SAIEME:317,WAILEY:330,ASDERI:225,COOWES:272,COOAVO:247,COOWEL:120};
var uppMap = {TESWIN:341,SAINOR:214,SAIEME:289,WAILEY:192,ASDERI:154,COOWES:177,COOAVO:222,COOWEL:73};

// ===== Customer helpers ("Other…" add) =====
function upcase6(s){ return (s||'').toUpperCase().replace(/[^A-Z]/g,'').slice(0,6); }
function isValidCode(s){ return /^[A-Z]{6}$/.test(s||''); }
function loadCustomCodes(){
  try{ var raw=localStorage.getItem(KEY_CODES); if(raw){ customCodes = JSON.parse(raw) || []; } }catch(e){ customCodes=[]; }
}
function saveCustomCodes(){ try{ localStorage.setItem(KEY_CODES, JSON.stringify(customCodes||[])); }catch(e){} }
function ensureOption(selectId, code){
  var sel = document.getElementById(selectId); if(!sel) return;
  for (var i=0;i<sel.options.length;i++){ if(sel.options[i].value===code){ return; } }
  var opt = document.createElement('option'); opt.value = code; opt.textContent = code;
  var other = sel.querySelector('option[value="__OTHER__"]');
  if(other) sel.insertBefore(opt, other); else sel.appendChild(opt);
}
function addCustomCode(code){
  if(customCodes.indexOf(code)===-1){ customCodes.push(code); saveCustomCodes(); }
  ensureOption('qcCustomer', code); ensureOption('oCust', code);
}
function resolveCustomer(prefix){ 
  var sel = document.getElementById(prefix+'Customer') || document.getElementById(prefix+'Cust');
  var other = document.getElementById(prefix+'Other');
  var val = sel.value;
  if(val==='__OTHER__'){
    var code = upcase6(other.value); other.value = code;
    var hint = document.getElementById(prefix+'OtherHint');
    if(!isValidCode(code)){ if(hint){ hint.classList.remove('hidden'); hint.textContent='Enter 6 letters (A–Z)'; } return null; }
    if(hint){ hint.classList.add('hidden'); }
    addCustomCode(code);
    sel.value = code; other.classList.add('hidden'); return code;
  }
  return val;
}
function toggleOther(prefix){
  var sel = document.getElementById(prefix+'Customer') || document.getElementById(prefix+'Cust');
  var input = document.getElementById(prefix+'Other');
  var hint = document.getElementById(prefix+'OtherHint');
  if(sel.value==='__OTHER__'){ input.classList.remove('hidden'); if(hint) hint.classList.remove('hidden'); input.focus(); }
  else { input.classList.add('hidden'); if(hint) hint.classList.add('hidden'); }
}

// ===== Tabs
function showTab(which){
  ['tabCalc','tabTracker','tabHistory'].forEach(function(id){ document.getElementById(id).classList.toggle('hidden', id!=='tab'+which.charAt(0).toUpperCase()+which.slice(1)); });
  ['tabCalcBtn','tabTrackBtn','tabHistBtn'].forEach(function(id){ document.getElementById(id).classList.remove('active'); });
  if(which==='calc') document.getElementById('tabCalcBtn').classList.add('active');
  if(which==='tracker') document.getElementById('tabTrackBtn').classList.add('active');
  if(which==='history') document.getElementById('tabHistBtn').classList.add('active');
  document.getElementById('liveBanner').classList.toggle('hidden', which!=='tracker');
  updateEndShiftVisibility();
}

// ===== Persistence
function saveAll(){ try { localStorage.setItem(KEY, JSON.stringify({version:'2.7.5', savedAt:new Date().toISOString(), picks, learned, history:historyDays })); } catch(e){} }
function loadAll(){ try { var raw = localStorage.getItem(KEY); if(raw){ var p=JSON.parse(raw); picks=p.picks||[]; learned=p.learned||{}; historyDays=p.history||[]; } } catch(e){} }

// ===== Helpers
function hm(str){ if(!str) return NaN; var a=str.split(':'); if(a.length<2) return NaN; var H=parseInt(a[0],10), M=parseInt(a[1],10); if(isNaN(H)||isNaN(M)) return NaN; return H + M/60; }
function fmtH(hours){ var total=Math.round(hours*60); var h=Math.floor(total/60); var m=total%60; return h+' h '+String(m).padStart(2,'0')+' m'; }
function nowHHMM(){ var d=new Date(); return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0'); }
function todayISO(){ var d=new Date(); return d.toISOString().slice(0,10); }
function snapNearestHour(hhmm){ var parts=hhmm.split(':'); var H=parseInt(parts[0],10), M=parseInt(parts[1],10)||0; if(M>=30) H=(H+1)%24; return String(H).padStart(2,'0')+':00'; }
function addMinutes(hhmm, mins){ var p=hhmm.split(':').map(x=>parseInt(x,10)); var total=p[0]*60+p[1]+mins; var H=((Math.floor(total/60))%24+24)%24; var M=((total%60)+60)%60; return String(H).padStart(2,'0')+':'+String(M).padStart(2,'0'); }
function setNow(id){ var el=document.getElementById(id); if(!el) return; var now=nowHHMM(); if(id==='tStart'){ var s=snapNearestHour(now); el.value=s; startTime=s; document.getElementById('snapHint').textContent='Start set to '+s+' (snapped from '+now+')'; updateSummary(); } else { el.value=now; } }
function showToast(msg){ var t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1800); }

// ===== Rates
function getLearnedRate(name){ var rec = learned[name]; return rec && rec.rate>0 ? rec.rate : 0; }
function getRate(name, overrideVal){ if(overrideVal>0 && overrideVal!==999) return {rate: overrideVal, src: 'override'}; var lr=getLearnedRate(name); if(lr>0) return {rate: Math.round(lr), src:'learned'}; return {rate: defaultRate[name]||300, src:'default'}; }

// ===== QuickCalc
function updCalc(){ 
  var name = resolveCustomer('qc'); if(!name) { document.getElementById('qcPallets').textContent='—'; document.getElementById('qcDur').textContent='—'; document.getElementById('qcRateUsed').textContent='—'; return; }
  var units = parseInt(document.getElementById('qcUnits').value||'0',10);
  var overrideRaw = document.getElementById('qcRate').value||'0'; var override = parseFloat(overrideRaw);
  if((overrideRaw||'').trim()==='999'){ shareUnlocked=true; applyShareGate(); }
  if(!units){ document.getElementById('qcPallets').textContent='—'; document.getElementById('qcDur').textContent='—'; document.getElementById('qcRateUsed').textContent='—'; return; }
  var r = getRate(name, override);
  var pallets = Math.max(1, Math.ceil(units/(uppMap[name]||300)));
  var hours = units / (r.rate||300);
  document.getElementById('qcPallets').textContent = pallets;
  document.getElementById('qcDur').textContent = fmtH(hours);
  document.getElementById('qcRateUsed').textContent = r.rate+' u/h ('+r.src+')';
}

// ===== Tracker flow
function beginShift(){ 
  var typed=document.getElementById('tStart').value; if(typed && !startTime) startTime=typed;
  document.getElementById('shiftCard').style.display='none';
  document.getElementById('activeOrderCard').style.display='block';
  document.getElementById('summaryCard').style.display='block';
  document.getElementById('completedCard').style.display='block';
  renderDone(); updateSummary(); updateEndShiftVisibility();
}

function startOrder(){ 
  var name = resolveCustomer('o'); if(!name) return;
  var total = parseInt(document.getElementById('oTotal').value||'0',10);
  if(!name || (!total && total!==0)) return alert('Enter customer and total units');
  current = {name:name, total:total, start: nowHHMM(), breaks: []};
  var ms = document.getElementById('mStart').value; if(ms){ current.start = ms; }
  tempWraps = []; undoStack = [{type:'start'}];
  document.getElementById('orderArea').style.display='block';
  document.getElementById('btnB').style.display='inline-block';
  document.getElementById('btnL').style.display='inline-block';
  document.getElementById('btnUndo').style.display='inline-block';
  document.getElementById('btnStart').style.display='none';
  document.getElementById('btnComplete').style.display='inline-block';
  renderTimeline(); updateEndShiftVisibility();
}

function undoLast(){ 
  if(!current){ showToast('Nothing to undo'); return; }
  var last = undoStack.pop(); if(!last){ showToast('Nothing to undo'); return; }
  if(last.type==='wrap'){ tempWraps.pop(); renderTimeline(); return; }
  if(last.type==='break'){ current.breaks.pop(); renderTimeline(); return; }
  if(last.type==='start'){ current=null; tempWraps=[]; document.getElementById('orderArea').style.display='none'; document.getElementById('btnB').style.display='none'; document.getElementById('btnL').style.display='none'; document.getElementById('btnUndo').style.display='none'; document.getElementById('btnStart').style.display='inline-block'; document.getElementById('btnComplete').style.display='none'; showToast('Order start undone'); updateEndShiftVisibility(); return; }
}

function addBreak(type){ 
  if(!current) { alert('No active order — unnecessary to log breaks in between orders.'); return; }
  var start = nowHHMM(); var mins = (type==='B')?20:30; var end = addMinutes(start, mins);
  current.breaks.push({type, start, end, minutes: mins}); undoStack.push({type:'break'});
  var tl = document.getElementById('orderTimeline'); tl.innerHTML += '<div class="tick"><span>'+(type==='B'?'🅱️ Break 20m':'🍽️ Lunch 30m')+' — '+start+' → <b>'+end+'</b></span><span class="meta">excludes '+mins+' min from order rate</span></div>';
}

function logWrap(){ 
  if(!current) return alert('Start an order first');
  var left = parseInt(document.getElementById('oLeft').value||'0',10);
  if(left<0 || left>current.total) return alert('Units left must be between 0 and total');
  var prevLeft = tempWraps.length?tempWraps[tempWraps.length-1].left:current.total;
  if(left>prevLeft) return alert('Units left cannot increase vs previous wrap');
  var done = prevLeft - left; if(done<=0) return alert('No progress since last wrap');
  tempWraps.push({left, done}); undoStack.push({type:'wrap'}); document.getElementById('oLeft').value=''; renderTimeline();
}

function renderTimeline(){ 
  var tl = document.getElementById('orderTimeline'); if(!current){ tl.innerHTML=''; return; }
  tl.innerHTML = '<div class="tick"><span>⏳ Order started</span><span class="meta">Start: '+current.start+' • Total: '+current.total+' u</span></div>';
  current.breaks.forEach(function(b){ tl.innerHTML += '<div class="tick"><span>'+(b.type==='B'?'🅱️ Break 20m':'🍽️ Lunch 30m')+' — '+b.start+' → <b>'+b.end+'</b></span><span class="meta">excludes '+b.minutes+' min</span></div>'; });
  tempWraps.forEach(function(w,i){ tl.innerHTML += '<div class="tick"><span>📦 Wrap '+(i+1)+': <b>'+w.done+'</b> done, <b>'+w.left+'</b> left</span></div>'; });
}

function completeOrder(){ 
  if(!current) return alert('Start an order first');
  var close = manualCloseTime || nowHHMM(); if(!startTime) return alert('Add shift start first');
  var lastLeft = tempWraps.length?tempWraps[tempWraps.length-1].left:current.total; var finalDone = lastLeft;
  var palletsCount = tempWraps.length + (finalDone>0?1:0); var unitsDone = current.total;
  var exclMins = current.breaks.reduce((a,b)=>a+(b.minutes||0),0);
  var order = { name: current.name, units: unitsDone, pallets: palletsCount, close: close, start: current.start, excl: exclMins };
  picks.push(order); lastClose = close;
  if(!learned[current.name]){ learned[current.name] = {rate:0, samples:0, netH:0, units:0}; }
  current=null; tempWraps=[]; undoStack=[]; manualCloseTime="";
  document.getElementById('orderArea').style.display='none'; document.getElementById('btnB').style.display='none'; document.getElementById('btnL').style.display='none'; document.getElementById('btnUndo').style.display='none'; document.getElementById('btnStart').style.display='inline-block'; document.getElementById('btnComplete').style.display='none'; document.getElementById('oLeft').value=''; document.getElementById('oTotal').value='';
  renderDone(); learnFrom(order); updateSummary(); saveAll(); showToast('Order closed at '+close); updateEndShiftVisibility();
}

function orderRateForOrder(o){ var s=hm(o.start), e=hm(o.close); if(isNaN(s)||isNaN(e)||e<=s) return 0; var elapsed=e-s; var excl=(o.excl||0)/60; var net=Math.max(0.01, elapsed-excl); return Math.round(o.units/net); }

function renderDone(){ var tb=document.getElementById('doneBody'); tb.innerHTML=''; picks.forEach(function(o,i){ var rate=orderRateForOrder(o); tb.innerHTML += '<tr><td>'+(i+1)+'</td><td>'+o.name+'</td><td>'+o.units+'</td><td>'+o.pallets+'</td><td>'+o.close+'</td><td>'+(rate>0?rate+' u/h':'—')+'</td></tr>'; }); }

// ===== End Shift visibility
function updateEndShiftVisibility(){
  var btn = document.getElementById('btnEndShift');
  var trackerVisible = !document.getElementById('tabTracker').classList.contains('hidden');
  var show = trackerVisible && !current && picks.length > 0;
  btn.style.display = show ? 'inline-block' : 'none';
}

// ===== End Shift / History
function endShift(){
  if(!picks.length){ alert('No orders to archive.'); return; }
  var dateStr=todayISO(); var shiftLen=parseFloat(document.getElementById('tLen').value||'9'); var totalUnits=picks.reduce((a,b)=>a+b.units,0);
  var tS=hm(startTime), tE=hm(lastClose); var liveRate=(!isNaN(tS)&&!isNaN(tE)&&tE>tS)?Math.round(totalUnits/(tE-tS)):0; var dayRate=shiftLen>0?Math.round(totalUnits/shiftLen):0;
  var snapshot={date:dateStr,start:startTime||'',end:lastClose||'',shiftLen, totalUnits, liveRate, dayRate, picks:picks.slice(0)};
  historyDays.push(snapshot); saveAll(); renderHistory();
  // reset for next day
  picks=[]; lastClose=''; current=null; tempWraps=[]; undoStack=[]; document.getElementById('orderArea').style.display='none'; document.getElementById('btnB').style.display='none'; document.getElementById('btnL').style.display='none'; document.getElementById('btnUndo').style.display='none'; document.getElementById('btnStart').style.display='inline-block'; document.getElementById('btnComplete').style.display='none'; document.getElementById('oLeft').value=''; document.getElementById('oTotal').value=''; document.getElementById('completedCard').style.display='none'; document.getElementById('summaryCard').style.display='none'; document.getElementById('shiftCard').style.display='block'; startTime=''; renderDone(); updateSummary(); showToast('Shift archived to History'); showTab('history'); updateEndShiftVisibility();
}

// ===== History + exports
function applyShareGate(){ var controls = document.querySelectorAll('.gate-share'); for (var i=0;i<controls.length;i++){ controls[i].style.display = shareUnlocked ? '' : 'none'; } }
function exportCSV(){ var rows=[['customer','units','pallets','start','close','excl_mins','order_rate']]; picks.forEach(o=>rows.push([o.name,o.units,o.pallets,o.start,o.close,o.excl,orderRateForOrder(o)])); var csv=rows.map(r=>r.join(',')).join('\n'); var blob=new Blob([csv],{type:'text/csv'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='wqt_session.csv'; a.click(); URL.revokeObjectURL(a.href); }
function exportJSON(){ var payload={version:'2.7.5', exportedAt:new Date().toISOString(), picks, learned, history:historyDays}; var blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='wqt_data.json'; a.click(); URL.revokeObjectURL(a.href); }
function clearHistory(){ if(!historyDays.length){ showToast('History already empty'); return; } if(!confirm('Clear ALL archived days? This cannot be undone.')) return; historyDays=[]; saveAll(); renderHistory(); showToast('History cleared'); }
function renderHistory(){ var host=document.getElementById('histList'); host.innerHTML=''; applyShareGate(); if(!historyDays.length){ host.innerHTML='<div class="hint">No archived days yet.</div>'; return; } var days=historyDays.slice(0).reverse(); days.forEach(function(d){ var head=document.createElement('button'); var boxState=d.dayRate>=300?'ok':(d.dayRate>=250?'warn':'bad'); head.className='accHead '+boxState; head.innerHTML='<div class="left"><span class="tag">'+new Date(d.date+'T12:00:00').toDateString().slice(0,15)+'</span><span>Units: <b>'+d.totalUnits+'</b></span><span>Day Avg: <b>'+d.dayRate+'</b> u/h</span><span>Live: <b>'+d.liveRate+'</b> u/h</span></div><span class="chev">▾</span>'; var body=document.createElement('div'); body.className='accBody'; var table='<table><thead><tr><th>#</th><th>Customer</th><th>Units</th><th>Pallets</th><th>Start</th><th>Closed</th><th>Order Rate</th></tr></thead><tbody>'; (d.picks||[]).forEach(function(o,i){ var s=hm(o.start), e=hm(o.close); var net=(!isNaN(s)&&!isNaN(e)&&e>s)?(e-s)-(o.excl||0)/60:0.01; var rate=Math.round(o.units/Math.max(0.01,net)); table+='<tr><td>'+(i+1)+'</td><td>'+o.name+'</td><td>'+o.units+'</td><td>'+o.pallets+'</td><td>'+o.start+'</td><td>'+o.close+'</td><td>'+rate+' u/h</td></tr>'; }); table+='</tbody></table>'; body.innerHTML='<div class="hint">Shift: '+(d.start||'—')+' → '+(d.end||'—')+' | Length '+d.shiftLen+' h</div>'+table; var wrap=document.createElement('div'); wrap.className='accordion'; wrap.appendChild(head); wrap.appendChild(body); host.appendChild(wrap); head.addEventListener('click', function(){ var open=body.style.display==='block'; body.style.display=open?'none':'block'; head.querySelector('.chev').textContent=open?'▾':'▴'; }); }); }

document.addEventListener('DOMContentLoaded', function(){
  // load persisted
  loadCustomCodes();
  customCodes.forEach(function(code){ ensureOption('qcCustomer', code); ensureOption('oCust', code); });
  loadAll(); renderHistory(); renderDone(); updateSummary();
  if(picks.length>0){ showTab('tracker'); } else if(historyDays.length>0){ showTab('history'); } else { showTab('calc'); }
  updateEndShiftVisibility();

  // Resilient listeners for selects (fix mobile “Other…” issue)
  ['qcCustomer','oCust'].forEach(function(id){
    ['change','input','click','keyup'].forEach(function(evt){
      var el=document.getElementById(id); if(el){ el.addEventListener(evt, function(){
        if(id==='qcCustomer'){ toggleOther('qc'); updCalc(); }
        if(id==='oCust'){ toggleOther('o'); }
      }); }
    });
  });

  // Enforce uppercase & live validation on "Other" fields
  ['qcOther','oOther'].forEach(function(id){
    var el=document.getElementById(id);
    if(!el) return;
    el.addEventListener('input', function(){ el.value = upcase6(el.value); });
  });

  // QuickCalc inputs
  ['qcUnits','qcRate'].forEach(function(id){ var el=document.getElementById(id); if(el) el.addEventListener('input', updCalc); });
  document.getElementById('qcRate').addEventListener('input', function(){ if((this.value||'').trim()==='999'){ shareUnlocked=true; applyShareGate(); } });

  var stEl=document.getElementById('tStart'); if(stEl) stEl.addEventListener('change', function(){ startTime=document.getElementById('tStart').value; updateSummary();});
  var imp=document.getElementById('impFile'); if(imp) imp.addEventListener('change', function(ev){ var f=ev.target.files&&ev.target.files[0]; if(!f) return; var fr=new FileReader(); fr.onload=function(){ try{ var data=JSON.parse(fr.result); if(Array.isArray(data.picks)){ data.picks.forEach(p=>picks.push(p)); } if(data.learned) learned=data.learned; if(Array.isArray(data.history)){ historyDays=(historyDays||[]).concat(data.history); } renderDone(); updateSummary(); renderHistory(); saveAll(); showToast('Imported'); } catch(e){ alert('Invalid JSON'); } }; fr.readAsText(f); });
  // Initial state of "Other…" visibility
  toggleOther('qc'); toggleOther('o');
  // Initial calc
  updCalc();
});
</script>
</body>
</html>
