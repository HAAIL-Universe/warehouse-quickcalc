Got it — I moved the Countback keypad above QuickCalc, removed the Apply → Units button, and added a live QuickCalc Result that updates as you type (uses the override u/h if provided, otherwise 300 by default). Here’s the full updated page:

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Warehouse QuickCalc & Tracker v3.3.5</title>
<style>
:root { --bg:#0b0d10; --card:#141821; --ink:#e8eef7; --muted:#9fb3c8; --accent:#2f6bff; --line:#243244; --ok:#1b6e36; --warn:#8a6a15; --bad:#7a2b2b; }
* { box-sizing: border-box; }
html,body { margin:0; padding:0; background:#0b0d10; color:var(--ink); font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
.wrap { max-width: 980px; margin: 0 auto; padding: 14px; }
h1 { font-size: 20px; margin:6px 0 10px; }
.tabs { display:flex; gap:8px; margin:6px 0 10px; position: sticky; top:0; background:var(--bg); padding-top:6px; z-index:15; }
.tabbtn { flex:1; text-align:center; padding:10px; border:1px solid #253348; border-radius:10px; background:#0f131b; color:var(--ink); font-weight:700; cursor:pointer; }
.tabbtn.active { border-color: var(--accent); box-shadow: inset 0 0 0 1px var(--accent); }
.hidden { display:none; }
.card { background:var(--card); border:1px solid #253348; border-radius:14px; padding:14px; margin: 10px 0; }
label { display:block; font-size:12px; color:var(--muted); margin-bottom:4px; }
input, select, button, textarea { font-size:16px; }
input[type="number"], input[type="time"], input[type="text"], select, textarea {
  width:100%; background:#0f131b; color:var(--ink); border:1px solid #29364a; border-radius:10px; padding:10px; outline:none;
}
textarea{ min-height:90px; resize:vertical; }
.row { display:flex; gap:10px; flex-wrap: wrap; }
.col { flex:1; min-width:220px; }
.btn { padding:10px 12px; border-radius:10px; border:1px solid #32507a; background:#1a2a40; color:var(--ink); font-weight:700; cursor:pointer; }
.btn.ghost { background:transparent; border-color:#29364a; }
.btn.ok { border-color:#2e6b3a; background:#173220; }
.btn.warn { border-color:#8a6a15; background:#30250f; }
.btn.bad { border-color:#7a2b2b; background:#331b1b; }
.btn.chip { padding:8px 10px; border-radius:999px; }
.btn.slim { padding:6px 10px; border-radius:999px; font-size:14px; }
.btn[disabled] { opacity:0.5; cursor:not-allowed; }
.pill { border-radius:12px; padding:10px 12px; background:#0f131b; border:1px solid #29364a; text-align:center; }
.pill h3 { margin:0; font-size:13px; color:#9fb3c8; }
.pill p { margin:6px 0 0; font-size:22px; font-weight:800; }
.rateBanner { position: sticky; top:48px; z-index:10; display:flex; gap:10px; margin:8px 0; }
.rateChip { flex:1; text-align:center; padding:10px; border-radius:10px; border:1px solid #29364a; background:#0f131b; }
.rateChip.good { border-color:#1f4830; background:#14271c; }
.rateChip.warn { border-color:#584a1a; background:#2a230f; }
.rateChip.bad { border-color:#4f1f1f; background:#2a1313; }
.timeline { margin-top:8px; border-left:2px solid #29364a; padding-left:10px; }
.tick { margin:6px 0; color:#cfe2ff; font-size:13px; display:flex; align-items:center; gap:8px; justify-content:space-between; }
.tick .meta { color:#9fb3c8; font-size:12px; }
table { width:100%; border-collapse:collapse; font-size:14px; }
th, td { border-bottom:1px dashed #253348; padding:8px 6px; text-align:left; }
th { color:#9fb3c8; }
tr.clickable { cursor:pointer; }
td.small { font-size:12px; color:#9fb3c8; }
.bottom-actions { margin: 20px 0 10px; display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
.bottom-actions .left { flex:1 1 auto; min-width:220px; }
.bottom-actions .right { flex:0 0 auto; white-space:nowrap; display:flex; gap:8px; }
.safetybar { margin: 8px 0 40px; }
.safetybar .btn { width:100%; border-style:dashed; opacity:0.8; }
.hint { color:#9fb3c8; font-size:12px; }
.tagbox { display:flex; flex-wrap:wrap; gap:8px; }
.tag { display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid #29364a; background:#0f131b; font-weight:700; }
.tag button { border:0; background:transparent; color:#9fb3c8; cursor:pointer; font-size:14px; }
.accordion .accHead { width:100%; text-align:left; padding:10px; border:1px solid #29364a; background:#0f131b; border-radius:10px; display:flex; align-items:center; justify-content:space-between; gap:10px; }
.accordion .accHead.ok { border-color:#1f4830; background:#14271c; }
.accordion .accHead.warn { border-color:#584a1a; background:#2a230f; }
.accordion .accHead.bad { border-color:#4f1f1f; background:#2a1313; }
.accordion .accBody { display:none; padding:10px 0 0 0; }
.toast { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#0f131b; border:1px solid #29364a; padding:10px 12px; border-radius:10px; display:none; z-index:30; }
.toast.show { display:block; }
.logwrap { padding:8px 10px; background:#0f131b; border:1px solid #29364a; border-radius:10px; margin:8px 0; }
.logrow { display:none; }
.logrow td { border-bottom:none; padding-top:0; }
.gate-pro { display:none; }

/* Modal */
.modal { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:20; }
.modal .box { width:min(560px,92vw); background:#0f131b; border:1px solid #29364a; border-radius:12px; padding:14px; }
.modal .hdr { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
.modal .hdr h3 { margin:0; font-size:16px; color:#cfe2ff; }
.modal .fld { margin:8px 0; }
.modal .actions { display:flex; justify-content:flex-end; gap:8px; margin-top:8px; }
.count { font-variant-numeric: tabular-nums; font-weight:800; font-size:28px; }

/* Custom dropdown */
.dd { position:relative; }
.dd-toggle { width:100%; text-align:left; padding:10px; border:1px solid #29364a; border-radius:10px; background:#0f131b; color:var(--ink); cursor:pointer; }
.dd.open .dd-menu { display:block; }
.dd-menu { position:absolute; z-index:12; left:0; right:0; top:110%; background:#0f131b; border:1px solid #29364a; border-radius:10px; padding:6px; display:none; max-height:280px; overflow:auto; }
.dd-group { border:1px solid #29364a; border-radius:8px; margin:6px 0; overflow:hidden; }
.dd-group h4 { margin:0; padding:8px 10px; background:#0b0d10; color:#cfe2ff; font-size:13px; cursor:pointer; display:flex; align-items:center; justify-content:space-between; }
.dd-items { display:none; padding:4px 6px; }
.dd-items button { width:100%; text-align:left; padding:8px 10px; background:transparent; border:0; color:var(--ink); cursor:pointer; border-radius:6px; }
.dd-items button:hover { background:#11151d; }
.dd-other { margin:6px 0 0; display:flex; gap:6px; }
.dd-other button { flex:1; }
.dd-other input { flex:1; }

/* Countback calc */
.cbCard { margin-top:8px; padding:10px; border-radius:12px; border:1px dashed #29364a; background:#0f131b; }
.cbRow { display:flex; gap:8px; align-items:center; }
.cbDisplay { flex:1; display:flex; gap:8px; }
.cbBox { flex:1; border:1px solid #29364a; border-radius:10px; padding:8px; }
.cbBox h4 { margin:0 0 6px; font-size:12px; color:#9fb3c8; }
.cbVal { font-weight:800; font-size:22px; min-height:28px; }
.cbPad { display:grid; grid-template-columns:repeat(3,1fr); gap:6px; max-width:240px; }
.cbPad button { padding:12px 0; border-radius:10px; border:1px solid #32507a; background:#1a2a40; color:var(--ink); font-weight:700; }
.cbChips { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
.cbSummary { margin-left:auto; text-align:right; font-weight:800; }
</style>
</head>
<body>
<div class="wrap">
  <h1>Warehouse QuickCalc & Tracker v3.3.5</h1>

  <div class="tabs">
    <button id="tabCalcBtn" class="tabbtn active" type="button" onclick="showTab('calc')">QuickCalc</button>
    <button id="tabTrackBtn" class="tabbtn" type="button" onclick="showTab('tracker')">Tracker</button>
    <button id="tabHistBtn" class="tabbtn" type="button" onclick="showTab('history')">History</button>
  </div>

  <div id="liveBanner" class="rateBanner hidden">
    <div id="chipRate" class="rateChip"><b>Live Rate</b><div id="chipRateVal">—</div></div>
    <div id="chipTotal" class="rateChip"><b>Total Units</b><div id="chipTotalVal">0</div></div>
    <div id="chipGap" class="rateChip"><b>Gap vs 300</b><div id="chipGapVal">—</div></div>
  </div>

  <!-- QuickCalc -->
  <section id="tabCalc">
    <!-- Countback calculator (moved ABOVE QuickCalc) -->
    <div class="cbCard">
      <div class="cbRow" style="flex-wrap:wrap; align-items:flex-start;">
        <div class="cbDisplay">
          <div class="cbBox">
            <h4>Layers</h4>
            <div id="cbLayers" class="cbVal">0</div>
          </div>
          <div class="cbBox">
            <h4>U/Layer</h4>
            <div id="cbUL" class="cbVal">0</div>
            <div id="cbChips" class="cbChips"></div>
          </div>
          <div class="cbBox">
            <h4>Extras</h4>
            <div id="cbExtras" class="cbVal">0</div>
          </div>
          <div class="cbSummary">
            <div class="hint">Total</div>
            <div id="cbTotal" class="count">0</div>
          </div>
        </div>
        <div style="flex:1; min-width:240px; display:flex; gap:8px;">
          <div class="cbPad" style="flex:0 0 240px;">
            <button onclick="cbTap('7')">7</button>
            <button onclick="cbTap('8')">8</button>
            <button onclick="cbTap('9')">9</button>
            <button onclick="cbTap('4')">4</button>
            <button onclick="cbTap('5')">5</button>
            <button onclick="cbTap('6')">6</button>
            <button onclick="cbTap('1')">1</button>
            <button onclick="cbTap('2')">2</button>
            <button onclick="cbTap('3')">3</button>
            <button onclick="cbTap('0')">0</button>
            <button onclick="cbBack()">⌫</button>
            <button onclick="cbReset()">Reset</button>
          </div>
          <div style="display:flex; flex-direction:column; gap:6px; flex:1;">
            <button class="btn" onclick="cbNextField()">Next →</button>
          </div>
        </div>
      </div>
      <div class="hint" id="cbHint">(Layers × U/Layer) + Extras</div>
    </div>

    <!-- QuickCalc inputs -->
    <div class="card">
      <div class="row">
        <div class="col">
          <label>Customer</label>
          <div class="row" style="gap:6px;">
            <div class="col">
              <select id="qcCustomer" class="hidden"></select>
              <div id="qcDD" class="dd">
                <button class="dd-toggle" type="button">Select customer…</button>
                <div class="dd-menu"></div>
              </div>
            </div>
            <div class="col">
              <input id="qcOther" type="text" class="hidden" maxlength="6" placeholder="ABCDEF" pattern="[A-Za-z]{6}">
            </div>
          </div>
        </div>
        <div class="col">
          <label>Units</label>
          <input id="qcUnits" type="number" min="1" step="1" inputmode="numeric" placeholder="e.g. 820">
        </div>
        <div class="col">
          <label>Override Rate (u/h)</label>
          <input id="qcRate" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="optional">
          <div class="hint">Type <b>0000</b> to unlock Pro (Export/Import & Manage Customers) — session only.</div>
        </div>
      </div>
      <!-- Live result -->
      <div class="row" style="margin-top:10px;">
        <div class="col">
          <div class="pill">
            <h3>Time Needed</h3>
            <p id="qcTime">—</p>
          </div>
        </div>
        <div class="col">
          <div class="pill">
            <h3>Rate Used</h3>
            <p id="qcRateUsed">300 u/h</p>
          </div>
        </div>
        <div class="col">
          <div class="pill">
            <h3>Units</h3>
            <p id="qcUnitsEcho">0</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Tracker -->
  <section id="tabTracker" class="hidden">
    <div class="card" id="shiftCard">
      <div class="row">
        <div class="col">
          <label>Shift Start (HH:MM)</label>
          <div class="row" style="gap:6px; align-items:flex-end;">
            <input id="tStart" type="time" placeholder="08:00" style="flex:1;">
            <button class="btn chip" style="flex:0 0 auto; margin-left:auto;" type="button" onclick="setNow('tStart')">Now</button>
          </div>
          <div id="snapHint" class="hint"></div>
        </div>
        <div class="col">
          <label>Shift Length (hours)</label>
          <input id="tLen" type="number" min="1" step="0.5" value="9">
        </div>
        <div class="col" style="align-self:end; text-align:right;">
          <button class="btn ok" type="button" onclick="beginShift()" id="btnBegin" style="min-width:180px;">Begin Tracking</button>
        </div>
      </div>
      <div class="hint">Daily avg uses full shift length. Live rate uses Start → last Wrap/Close (includes breaks & delays).</div>
    </div>

    <div class="card" id="activeOrderCard" style="display:none;">
      <div class="row" style="align-items:flex-end;">
        <div class="col">
          <label>Customer</label>
          <div class="row" style="gap:6px;">
            <div class="col">
              <select id="oCust" class="hidden"></select>
              <div id="oDD" class="dd">
                <button class="dd-toggle" type="button">Select customer…</button>
                <div class="dd-menu"></div>
              </div>
            </div>
            <div class="col">
              <input id="oOther" type="text" class="hidden" maxlength="6" placeholder="ABCDEF" pattern="[A-Za-z]{6}">
            </div>
          </div>
        </div>
        <div class="col">
          <label>Total units</label>
          <input id="oTotal" type="number" min="1" step="1" inputmode="numeric" placeholder="e.g. 1024">
        </div>
        <div class="col" style="display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;">
          <button id="btnUndo" class="btn slim" type="button" onclick="undoLast()" style="display:none;">Undo</button>
          <span style="flex:1"></span>
          <button id="btnB" class="btn chip" type="button" title="Start 20 min break" onclick="openBreakModal('B')" style="display:none;">B</button>
          <button id="btnL" class="btn chip" type="button" title="Start 30 min lunch" onclick="openBreakModal('L')" style="display:none;">L</button>
          <button class="btn" type="button" onclick="startOrder()" id="btnStart" disabled>Start</button>
          <button class="btn ok" type="button" onclick="completeOrder()" id="btnComplete" style="display:none;">Complete</button>
        </div>
      </div>

      <div id="orderArea" style="display:none; margin-top:10px;">
        <div class="row">
          <div class="col">
            <label>Units left (log wrap)</label>
            <input id="oLeft" type="number" min="0" step="1" inputmode="numeric" placeholder="e.g. 413">
          </div>
          <div class="col" style="display:flex; align-items:flex-end; gap:6px;">
            <div class="col" style="max-width:160px;"><button class="btn" type="button" onclick="logWrap()">Log Wrap</button></div>
          </div>
        </div>
        <div class="timeline" id="orderTimeline"></div>
      </div>
    </div>

    <div class="card" id="completedCard" style="display:none;">
      <h3 style="margin:0 0 8px; font-size:14px; color:#9fb3c8;">Completed Orders</h3>
      <table>
        <thead><tr><th>#</th><th>Customer</th><th>Units</th><th>Pallets</th><th>Start</th><th>Closed</th><th>Order Rate</th></tr></thead>
        <tbody id="doneBody"></tbody>
      </table>
    </div>

    <div class="bottom-actions">
      <div class="left">
        <button class="btn" type="button" id="btnDelay" onclick="openDelayModal()" style="display:none;">Log Delay ⏱️</button>
      </div>
      <div class="right">
        <button class="btn" type="button" id="btnCloseEarly" onclick="openCloseEarlyModal()" style="display:none;">Close Early…</button>
        <button class="btn ok" type="button" id="btnEndShift" onclick="endShift()" style="min-width:220px;">End Shift & Archive →</button>
      </div>
    </div>
    <div class="safetybar">
      <button class="btn ghost" type="button" onclick="clearToday()">Clear today's data</button>
    </div>
  </section>

  <!-- History -->
  <section id="tabHistory" class="hidden">
    <div class="card">
      <div style="display:flex; gap:8px; justify-content:space-between; align-items:center; flex-wrap:wrap;">
        <h3 style="margin:0; font-size:14px; color:#9fb3c8;">History (daily archives)</h3>
        <div>
          <button class="btn gate-pro" type="button" onclick="exportCSV()">Export CSV (today)</button>
          <button class="btn gate-pro" type="button" onclick="exportJSON()">Export JSON (all)</button>
          <label id="impLabel" class="btn gate-pro" for="impFile">Import JSON</label><input id="impFile" type="file" accept="application/json" style="display:none;">
          <button class="btn" type="button" style="background:#331b1b;border-color:#7a2b2b;" onclick="clearHistory()">Clear History</button>
          <button class="btn gate-pro" type="button" onclick="toggleManageCustomers()">Manage Customers</button>
        </div>
      </div>
      <div id="histList" style="margin-top:8px;"></div>
    </div>

    <div id="manageCustomersCard" class="card hidden">
      <h3 style="margin:0 0 8px; font-size:14px; color:#9fb3c8;">Manage Customers</h3>
      <div class="hint">Manually-added customers are shown below. Tap ✖ to remove.</div>
      <div id="custTags" class="tagbox" style="margin-top:8px;"></div>
      <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end;">
        <button class="btn ghost" type="button" onclick="reloadDropdowns()">Reload dropdowns</button>
        <button class="btn bad" type="button" onclick="clearAllCustom()">Clear ALL custom customers</button>
      </div>
    </div>
  </section>
</div>

<!-- Delay Modal -->
<div id="delayModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="delayTitle">
  <div class="box">
    <div class="hdr">
      <h3 id="delayTitle">Log Delay</h3>
      <button class="btn slim ghost" type="button" onclick="closeDelayModal()">✖</button>
    </div>
    <div class="fld">
      <label>Start (auto)</label>
      <input id="delayStart" type="time" readonly>
    </div>
    <div class="fld">
      <label>Cause</label>
      <textarea id="delayCause" placeholder="e.g., Waiting on forklift / aisle blocked / label misprint"></textarea>
    </div>
    <div class="actions">
      <button class="btn ghost" type="button" onclick="cancelDelay()">Cancel</button>
      <button class="btn ok" type="button" onclick="submitDelay()">Submit & Stop</button>
    </div>
  </div>
</div>

<!-- Break Timer Modal -->
<div id="breakModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="breakTitle">
  <div class="box">
    <div class="hdr">
      <h3 id="breakTitle">Break</h3>
      <button class="btn slim ghost" type="button" onclick="cancelBreak()">✖</button>
    </div>
    <div class="fld">
      <div class="hint">Started at <b id="breakStartLabel">--:--</b> • Target <span id="breakTargetLabel">--</span></div>
    </div>
    <div class="fld" style="display:flex; align-items:center; gap:10px;">
      <div class="count" id="breakCountdown">00:00</div>
      <label style="display:flex; align-items:center; gap:6px;"><input id="breakAlarm" type="checkbox"> Alarm at zero</label>
    </div>
    <div class="actions">
      <button class="btn ghost" type="button" onclick="cancelBreak()">Cancel</button>
      <button class="btn ok" type="button" onclick="submitBreak()">End Break</button>
    </div>
  </div>
</div>

<!-- Close Early Modal -->
<div id="closeEarlyModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="closeEarlyTitle">
  <div class="box">
    <div class="hdr">
      <h3 id="closeEarlyTitle">Close Order Early</h3>
      <button class="btn slim ghost" type="button" onclick="closeCloseEarlyModal()">✖</button>
    </div>
    <div class="fld">
      <label>Remaining units</label>
      <input id="ceRemaining" type="number" min="0" step="1" inputmode="numeric" placeholder="0">
    </div>
    <div class="fld">
      <label style="display:flex;align-items:center;gap:8px;">
        <input id="ceWrapped" type="checkbox"> Wrapped last pallet
      </label>
    </div>
    <div class="actions">
      <button class="btn ghost" type="button" onclick="closeCloseEarlyModal()">Cancel</button>
      <button class="btn ok" type="button" onclick="submitCloseEarly()">Close Order</button>
    </div>
  </div>
</div>

<div id="toast" class="toast">Saved</div>

<script>
// ====== State ======
let picks = [];         // closed orders
let tempWraps = [];     // wraps in current order
let current = null;     // active order
let startTime = "";     // shift start (HH:MM)
let lastClose = "";     // last order close time
let undoStack = [];     // undo actions for current order
let learned = {};       // placeholder
let historyDays = [];   // archived days
let customCodes = [];   // user-added customer codes
let shiftBreaks = [];   // breaks without an active order

// Countback focus & values
let cbFocus = 'layers'; // 'layers' | 'ul' | 'extras'
let cbVals = {layers:'', ul:'', extras:''};

const KEY = 'wqt_v2722_data';
const KEY_CODES = 'wqt_codes';
const KEY_LEARN = 'wqt_learn_ul';
const PRO_UNLOCK_CODE = '0000';
let proUnlocked = false;  // Gate: Export/Import/Manage Customers

// Delay / Break
let delayDraft = null; // {start:'HH:MM', cause:''}
let breakDraft = null; // {type:'B'|'L', startHHMM, targetSec, beeping}
let breakTickId = null;

// ====== Utils ======
function showToast(msg){ try{ var t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400);}catch(e){} }
function hm(str){ if(!str) return NaN; var a=str.split(':'), H=parseInt(a[0],10), M=parseInt(a[1],10); if(isNaN(H)||isNaN(M)) return NaN; return H + M/60; }
function nowHHMM(){ var d=new Date(); return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0'); }
function todayISO(){ var d=new Date(); return d.toISOString().slice(0,10); }
function fmtMMSS(totalSec){ var s=Math.max(0,Math.round(totalSec)); var m=Math.floor(s/60), r=s%60; return String(m).padStart(2,'0')+':'+String(r).padStart(2,'0'); }
function pad2(n){return String(n).padStart(2,'0');}
function minutesToHHMM(x){ const h=Math.floor(x/60), m=x%60; return pad2(h)+':'+pad2(m); }
function toInt(s){ const n=parseInt(s||'0',10); return isNaN(n)?0:n; }

// ====== Persistence ======
function loadAll(){
  try {
    var raw=localStorage.getItem(KEY);
    if(raw){
      var p=JSON.parse(raw);
      picks=p.picks||[]; learned=p.learned||{}; historyDays=p.history||[];
      current=p.current||null; tempWraps=p.tempWraps||[]; startTime=p.startTime||""; lastClose=p.lastClose||""; undoStack=p.undoStack||[];
      proUnlocked = !!p.proUnlocked;
      shiftBreaks = p.shiftBreaks || [];
    }
    var lraw = localStorage.getItem(KEY_LEARN);
    if(lraw){ learnedUL = JSON.parse(lraw)||{}; }
  } catch(e){ console.error(e); }
}
function saveAll(){
  try {
    localStorage.setItem(KEY, JSON.stringify({
      version:'3.3.5', savedAt:new Date().toISOString(),
      picks, learned, history:historyDays,
      current, tempWraps, startTime, lastClose, undoStack,
      proUnlocked, shiftBreaks
    }));
    localStorage.setItem(KEY_LEARN, JSON.stringify(learnedUL));
  } catch(e){ console.error(e); }
}
setInterval(function(){ saveAll(); }, 30000);

// Custom codes
function loadCustomCodes(){ try{ var raw=localStorage.getItem(KEY_CODES); if(raw){ customCodes=JSON.parse(raw)||[]; } }catch(e){ customCodes=[]; } }
function saveCustomCodes(){ try{ localStorage.setItem(KEY_CODES, JSON.stringify(customCodes||[])); }catch(e){} }

// ====== Grouped dropdowns ======
const DEFAULT_CODES = [
  'ASDAVO','ASDERI','ASDFAL','ASDLUT','ASDWAS',
  'BOOHAY',
  'COOAVO','COOLEA','COOWEL','COOWES',
  'MORNOR','MORWAK',
  'OCAPUR',
  'SAIEME','SAINOR','SAITHA',
  'TESDID','TESWIN',
  'WAILEY'
];
function upcase6(s){ return (s||'').toUpperCase().replace(/[^A-Z]/g,'').slice(0,6); }
function isValidCode(s){ return /^[A-Z]{6}$/.test(s||''); }
function prefix3(code){ return (code||'').slice(0,3).toUpperCase(); }
function groupedMap(all){
  const map={};
  all.forEach(c=>{ const p=prefix3(c); (map[p]=map[p]||[]).push(c); });
  Object.keys(map).forEach(k=>map[k].sort());
  return Object.fromEntries(Object.entries(map).sort(([a],[b])=>a.localeCompare(b)));
}

function buildDropdown(ddId, selectId, otherInputId, prefix){
  const sel = document.getElementById(selectId);
  const dd  = document.getElementById(ddId);
  const menu = dd.querySelector('.dd-menu');
  const btn = dd.querySelector('.dd-toggle');
  const otherInput = document.getElementById(otherInputId);

  function setValue(val){
    sel.value = val;
    btn.textContent = val==='__OTHER__' ? 'Other…' : val;
    onCustomerChange(prefix);
    if(prefix==='o') refreshStartButton();
    saveAll();
    dd.classList.remove('open');
  }

  function render(){
    menu.innerHTML = "";
    const all = Array.from(new Set([...(DEFAULT_CODES||[]), ...(customCodes||[])]));
    const groups = groupedMap(all);
    Object.keys(groups).forEach(g=>{
      const wrap = document.createElement('div'); wrap.className='dd-group';
      const head = document.createElement('h4'); head.innerHTML = `<span>${g}</span><span>▾</span>`;
      const items = document.createElement('div'); items.className='dd-items';
      head.addEventListener('click', (e)=>{
        e.stopPropagation();
        const open = items.style.display==='block';
        items.style.display = open?'none':'block';
        head.lastChild.textContent = open?'▾':'▴';
      });
      groups[g].forEach(code=>{
        const it = document.createElement('button'); it.type='button'; it.textContent=code;
        it.addEventListener('click', (e)=>{ e.stopPropagation(); setValue(code); });
        items.appendChild(it);
      });
      wrap.appendChild(head); wrap.appendChild(items);
      menu.appendChild(wrap);
    });

    // Other… row
    const row = document.createElement('div'); row.className='dd-other';
    const otherBtn = document.createElement('button'); otherBtn.className='btn slim'; otherBtn.textContent='Other…'; otherBtn.type='button';
    otherBtn.addEventListener('click', (e)=>{
      e.stopPropagation();
      setValue('__OTHER__');
      otherInput.classList.remove('hidden'); otherInput.focus();
    });
    row.appendChild(otherBtn);
    menu.appendChild(row);

    menu.addEventListener('click', (e)=> e.stopPropagation());
  }

  btn.addEventListener('click', (e)=>{
    e.stopPropagation();
    document.querySelectorAll('.dd.open').forEach(x=>{ if(x!==dd) x.classList.remove('open'); });
    dd.classList.toggle('open');
    if(dd.classList.contains('open')) { menu.scrollTop = 0; }
  });

  document.addEventListener('click', (e)=>{
    if(!dd.contains(e.target)) dd.classList.remove('open');
  });

  render();
  btn.textContent = sel.value ? (sel.value==='__OTHER__' ? 'Other…' : sel.value) : 'Select customer…';
  dd.__reload = render;
}

function reloadDropdowns(){
  const uniq = Array.from(new Set([...(DEFAULT_CODES||[]), ...(customCodes||[])]));
  const qcSel = document.getElementById('qcCustomer');
  const oSel  = document.getElementById('oCust');
  function refill(sel){
    sel.innerHTML='';
    uniq.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
    const other=document.createElement('option'); other.value='__OTHER__'; other.textContent='Other…'; sel.appendChild(other);
  }
  refill(qcSel); refill(oSel);

  if(document.getElementById('qcDD').__reload) document.getElementById('qcDD').__reload();
  if(document.getElementById('oDD').__reload)  document.getElementById('oDD').__reload();
}

function onCustomerChange(prefix){
  const sel   = document.getElementById(prefix==='qc' ? 'qcCustomer' : 'oCust');
  const input = document.getElementById(prefix==='qc' ? 'qcOther'    : 'oOther');
  if(!sel || !input) return;
  if(sel.value==='__OTHER__'){ input.classList.remove('hidden'); input.focus(); }
  else { input.classList.add('hidden'); }
  if(prefix==='o') refreshStartButton();
  renderULayerChips();
  saveAll();
}

function onOtherInput(prefix){
  const sel   = document.getElementById(prefix==='qc' ? 'qcCustomer' : 'oCust');
  const input = document.getElementById(prefix==='qc' ? 'qcOther'    : 'oOther');
  const dd    = document.getElementById(prefix==='qc' ? 'qcDD'       : 'oDD');
  if(!sel || !input) return;
  const before = input.value;
  input.value = upcase6(input.value);
  if(before!==input.value && prefix==='o') refreshStartButton();
  const code = input.value;
  if(isValidCode(code)){
    if(customCodes.indexOf(code)===-1){
      customCodes.push(code); saveCustomCodes();
    }
    reloadDropdowns();
    sel.value = code;
    input.classList.add('hidden');
    if(dd && dd.querySelector('.dd-toggle')) dd.querySelector('.dd-toggle').textContent = code;
    if(prefix==='o') refreshStartButton();
    showToast('Added '+code);
    renderULayerChips();
    saveAll();
  }
}

// ====== Pro Gate ======
function applyProGate(){
  document.querySelectorAll('.gate-pro').forEach(el=> el.style.display = proUnlocked ? '' : 'none');
  saveAll();
}
function updCalcGate(){
  const el = document.getElementById('qcRate');
  const raw = (el.value||'').toString().trim();
  if(raw.replace(/\s/g,'') === PRO_UNLOCK_CODE && !proUnlocked){
    proUnlocked = true;
    el.value = '';
    el.blur();
    applyProGate();
    showToast('Pro unlocked for this session');
    recalcQuick();
  }
}

// ====== Tabs ======
function showTab(which){
  const id = 'tab'+which.charAt(0).toUpperCase()+which.slice(1);
  ['tabCalc','tabTracker','tabHistory'].forEach(x=>document.getElementById(x).classList.toggle('hidden', x!==id));
  ['tabCalcBtn','tabTrackBtn','tabHistBtn'].forEach(x=>document.getElementById(x).classList.remove('active'));
  if(which==='calc') document.getElementById('tabCalcBtn').classList.add('active');
  if(which==='tracker') document.getElementById('tabTrackBtn').classList.add('active');
  if(which==='history') document.getElementById('tabHistBtn').classList.add('active');
  document.getElementById('liveBanner').classList.toggle('hidden', which!=='tracker');
  updateDelayBtn(); updateEndShiftVisibility(); updateCloseEarlyVisibility();
  saveAll();
}

// ====== Tracker core ======
function setNow(id){ var el=document.getElementById(id); var now=nowHHMM(); if(id==='tStart'){ el.value=now; startTime=now; document.getElementById('snapHint').textContent='Start set to '+now; updateSummary(); } else { el.value=now; } saveAll(); }

function beginShift(){
  const typed=document.getElementById('tStart').value;
  if(!typed){ document.getElementById('tStart').focus(); return alert('Please set shift start time'); }
  if(!startTime) startTime=typed;
  document.getElementById('shiftCard').style.display='none';
  document.getElementById('activeOrderCard').style.display='block';
  document.getElementById('completedCard').style.display='block';
  ['btnB','btnL'].forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display='inline-block'; });
  renderDone(); updateSummary(); updateDelayBtn(); updateEndShiftVisibility(); updateCloseEarlyVisibility(); saveAll();
}

function refreshStartButton(){
  const sel = document.getElementById('oCust');
  const other = document.getElementById('oOther');
  const total = parseInt(document.getElementById('oTotal').value||'0',10);
  const hasCust = sel.value && sel.value!=='__OTHER__' || (sel.value==='__OTHER__' && /^[A-Z]{6}$/.test((other.value||'').toUpperCase()));
  const ok = hasCust && total>0;
  const btn = document.getElementById('btnStart');
  btn.disabled = !ok;
}

function startOrder(){
  const sel=document.getElementById('oCust'); 
  const name=sel.value;
  const total=parseInt(document.getElementById('oTotal').value||'0',10);
  if(!startTime){ return alert('Set shift start before starting an order.'); }
  if(!(name && name!=='__OTHER__') && !(name==='__OTHER__' && /^[A-Z]{6}$/.test((document.getElementById('oOther').value||'').toUpperCase()))){
    return alert('Select a valid customer code');
  }
  if(!(total>0)) return alert('Enter total units');
  const finalName = (name==='__OTHER__') ? document.getElementById('oOther').value.toUpperCase() : name;

  current={name:finalName, total:total, start: nowHHMM(), breaks: []};
  tempWraps=[]; undoStack=[{type:'start'}];
  document.getElementById('orderArea').style.display='block';
  ['btnB','btnL','btnUndo'].forEach(id=>document.getElementById(id).style.display='inline-block');
  document.getElementById('btnStart').style.display='none';
  document.getElementById('btnComplete').style.display='inline-block';
  renderTimeline(); updateSummary(); updateDelayBtn(); updateEndShiftVisibility(); updateCloseEarlyVisibility(); saveAll();
}

function logWrap(){
  if(!current) return alert('Start an order first');
  var left=parseInt(document.getElementById('oLeft').value||'0',10);
  if(left<0 || left>current.total) return alert('Units left must be between 0 and total');
  var prevLeft=tempWraps.length?tempWraps[tempWraps.length-1].left:current.total;
  if(left>prevLeft) return alert('Units left cannot increase vs previous wrap');
  var done=prevLeft-left; if(done<=0) return alert('No progress since last wrap');
  var t= nowHHMM();
  tempWraps.push({left,done,t}); undoStack.push({type:'wrap'});
  document.getElementById('oLeft').value=''; renderTimeline(); updateSummary(); saveAll();
}

function undoLast(){
  if(!current){ showToast('Nothing to undo'); return; }
  var last=undoStack.pop(); if(!last){ showToast('Nothing to undo'); return; }
  if(last.type==='wrap'){ tempWraps.pop(); renderTimeline(); updateSummary(); saveAll(); return; }
  if(last.type==='break'){ current.breaks.pop(); renderTimeline(); updateSummary(); saveAll(); return; }
  if(last.type==='delay' && current.__lastDelay){ current.breaks = current.breaks.filter(b=>b!==current.__lastDelay); current.__lastDelay=null; renderTimeline(); updateSummary(); saveAll(); return; }
  if(last.type==='start'){
    current=null; tempWraps=[];
    document.getElementById('orderArea').style.display='none';
    ['btnB','btnL','btnUndo'].forEach(id=>document.getElementById(id).style.display='none');
    document.getElementById('btnStart').style.display='inline-block';
    document.getElementById('btnComplete').style.display='none';
    showToast('Order start undone'); updateDelayBtn(); updateEndShiftVisibility(); updateCloseEarlyVisibility(); updateSummary(); saveAll(); return;
  }
}

function completeOrder(){
  if(!current) return alert('Start an order first');
  var close= nowHHMM();
  if(!startTime) return alert('Add shift start first');
  var lastLeft=tempWraps.length?tempWraps[tempWraps.length-1].left:current.total;
  var palletsCount=tempWraps.length;
  var unitsDone=current.total - (lastLeft||0);
  var exclMins=current.breaks.reduce((a,b)=>a+(b.minutes||0),0);
  var order={name:current.name, units:unitsDone, pallets:palletsCount, close, start:current.start, excl:exclMins, log:{wraps: tempWraps.slice(0), breaks: current.breaks.slice(0)}};
  picks.push(order); lastClose=close;
  current=null; tempWraps=[]; undoStack=[];
  document.getElementById('orderArea').style.display='none';
  ['btnUndo'].forEach(id=>document.getElementById(id).style.display='none');
  document.getElementById('btnStart').style.display='inline-block';
  document.getElementById('btnStart').disabled=true;
  document.getElementById('btnComplete').style.display='none';
  document.getElementById('oLeft').value=''; document.getElementById('oTotal').value='';
  renderDone(); updateSummary(); updateDelayBtn(); saveAll(); showToast('Order closed at '+close);
  updateEndShiftVisibility(); updateCloseEarlyVisibility();
}

// ====== Delay logging ======
function updateDelayBtn(){ var el=document.getElementById('btnDelay'); if(el) el.style.display = current ? 'inline-block' : 'none'; }
function openDelayModal(){
  if(!current) return alert('Start an order to log a delay');
  delayDraft = { start: nowHHMM(), cause: '' };
  document.getElementById('delayStart').value = delayDraft.start;
  document.getElementById('delayCause').value = '';
  document.getElementById('delayModal').style.display='flex';
}
function closeDelayModal(){ document.getElementById('delayModal').style.display='none'; }
function cancelDelay(){ delayDraft=null; closeDelayModal(); }
function submitDelay(){
  if(!current || !delayDraft){ closeDelayModal(); return; }
  var end = nowHHMM();
  var minutes = Math.max(1, Math.round((hm(end)-hm(delayDraft.start))*60));
  var cause = (document.getElementById('delayCause').value||'').trim();
  var entry = {type:'D', start: delayDraft.start, end, minutes, cause};
  current.breaks.push(entry);
  current.__lastDelay = entry;
  undoStack.push({type:'delay'});
  delayDraft=null;
  closeDelayModal();
  renderTimeline(); updateSummary(); showToast('Delay logged ('+minutes+'m)'); saveAll();
}

// ====== Break timer modal ======
function openBreakModal(kind){
  var mins = (kind==='B')?20:30;
  var start = nowHHMM();
  breakDraft = {type:kind, startHHMM:start, targetSec: mins*60, beeping:false};
  document.getElementById('breakTitle').textContent = (kind==='B'?'Break':'Lunch');
  document.getElementById('breakStartLabel').textContent = start;
  document.getElementById('breakTargetLabel').textContent = mins+' min target';
  document.getElementById('breakCountdown').textContent = fmtMMSS(breakDraft.targetSec);
  document.getElementById('breakAlarm').checked = false;
  document.getElementById('breakModal').style.display='flex';
  if(breakTickId) clearInterval(breakTickId);
  breakTickId = setInterval(function(){
    if(!breakDraft) return;
    var now = nowHHMM();
    var elapsed = Math.max(0, Math.round((hm(now)-hm(breakDraft.startHHMM))*3600));
    var remaining = Math.max(0, breakDraft.targetSec - elapsed);
    document.getElementById('breakCountdown').textContent = fmtMMSS(remaining);
    if(remaining===0 && !breakDraft.beeping && document.getElementById('breakAlarm').checked){
      breakDraft.beeping = true; tryBeep();
    }
  },1000);
}
function tryBeep(){
  try{
    var ctx = new (window.AudioContext||window.webkitAudioContext)();
    var o = ctx.createOscillator(); var g=ctx.createGain(); o.connect(g); g.connect(ctx.destination);
    o.type='sine'; o.frequency.value=880; g.gain.setValueAtTime(0.001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.02);
    o.start();
    setTimeout(function(){ g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.1); o.stop(); ctx.close(); }, 1200);
    if(navigator.vibrate) navigator.vibrate(200);
  }catch(e){ /* ignore */ }
}
function submitBreak(){
  if(!breakDraft){ return cancelBreak(); }
  var end = nowHHMM();
  var minutes = Math.max(1, Math.round((hm(end)-hm(breakDraft.startHHMM))*60));
  var entry = {type: breakDraft.type, start: breakDraft.startHHMM, end, minutes};
  if(current){ current.breaks.push(entry); undoStack.push({type:'break'}); renderTimeline(); }
  else { shiftBreaks.push(entry); }
  cancelBreak();
  updateSummary(); showToast((entry.type==='B'?'Break':'Lunch')+' logged ('+minutes+'m)'); saveAll();
}
function cancelBreak(){
  if(breakTickId){ clearInterval(breakTickId); breakTickId=null; }
  breakDraft=null;
  document.getElementById('breakModal').style.display='none';
}

// ====== Close Early ======
function updateCloseEarlyVisibility(){
  var btn=document.getElementById('btnCloseEarly');
  var trackerVisible=!document.getElementById('tabTracker').classList.contains('hidden');
  btn.style.display = (trackerVisible && !!current) ? 'inline-block' : 'none';
}
function openCloseEarlyModal(){
  if(!current) return;
  document.getElementById('ceRemaining').value='';
  document.getElementById('ceWrapped').checked=false;
  document.getElementById('closeEarlyModal').style.display='flex';
}
function closeCloseEarlyModal(){ document.getElementById('closeEarlyModal').style.display='none'; }
function submitCloseEarly(){
  if(!current) return closeCloseEarlyModal();
  var remaining = parseInt(document.getElementById('ceRemaining').value||'0',10);
  if(isNaN(remaining) || remaining<0) return alert('Enter remaining units (0 or more).');
  var prevLeft=tempWraps.length?tempWraps[tempWraps.length-1].left:current.total;
  if(remaining>prevLeft) return alert('Remaining cannot exceed current left ('+prevLeft+').');

  var wrapped = !!document.getElementById('ceWrapped').checked;
  if(wrapped){
    if(remaining>=prevLeft) return alert('To mark a wrap, remaining must be less than '+prevLeft+'.');
    tempWraps.push({left:remaining, done:prevLeft-remaining, t: nowHHMM()});
  }
  var close = nowHHMM();
  var palletsCount = tempWraps.length;
  var unitsDone = current.total - remaining;

  var exclMins=current.breaks.reduce((a,b)=>a+(b.minutes||0),0);
  var order={name:current.name, units:unitsDone, pallets:palletsCount, close, start:current.start, excl:exclMins, log:{wraps: tempWraps.slice(0), breaks: current.breaks.slice(0)}};
  picks.push(order); lastClose=close;

  // reset
  current=null; tempWraps=[]; undoStack=[];
  document.getElementById('orderArea').style.display='none';
  ['btnUndo'].forEach(id=>document.getElementById(id).style.display='none');
  document.getElementById('btnStart').style.display='inline-block';
  document.getElementById('btnStart').disabled=true;
  document.getElementById('btnComplete').style.display='none';
  document.getElementById('oLeft').value=''; document.getElementById('oTotal').value='';
  closeCloseEarlyModal();
  renderDone(); updateSummary(); updateDelayBtn(); saveAll(); showToast('Order closed early');
  updateEndShiftVisibility(); updateCloseEarlyVisibility();
}

// ====== Completed orders & history ======
function renderTimeline(){
  var tl=document.getElementById('orderTimeline'); if(!tl) return;
  tl.innerHTML='';
  (current?.breaks||[]).forEach(function(b){
    const row=document.createElement('div'); row.className='tick';
    row.innerHTML = (b.type==='D')
      ? `<span>⏱️ Delay${b.cause?': '+b.cause.replace(/</g,'&lt;'):''}</span><span class="meta">${b.start} → ${b.end} • ${b.minutes}m</span>`
      : `<span>☕ ${(b.type==='B')?'Break':'Lunch'}</span><span class="meta">${b.start} → ${b.end} • ${b.minutes}m</span>`;
    tl.appendChild(row);
  });
  tempWraps.forEach(function(w,wi){
    const row=document.createElement('div'); row.className='tick';
    row.innerHTML = `<span>📦 Wrap ${wi+1}: <b>${w.done}</b> done, <b>${w.left}</b> left</span><span class="meta">${w.t}</span>`;
    tl.appendChild(row);
  });
}

function renderDone(){
  var tb=document.getElementById('doneBody'); tb.innerHTML='';
  picks.forEach(function(o,i){
    var s=hm(o.start), e=hm(o.close);
    var excl=(o.log && Array.isArray(o.log.breaks))? o.log.breaks.reduce((a,b)=>a+(b.minutes||0),0) : (o.excl||0);
    var net=(e>s)?(e-s)-(excl)/60:0.01; var rate=Math.round(o.units/Math.max(0.01,net));
    var tr = document.createElement('tr'); tr.className='clickable'; tr.dataset.idx=i;
    tr.innerHTML = '<td>'+(i+1)+'</td><td>'+o.name+'</td><td>'+o.units+'</td><td>'+o.pallets+'</td><td>'+o.start+'</td><td>'+o.close+'</td><td>'+rate+' u/h</td>';
    tb.appendChild(tr);
    var logTr = document.createElement('tr'); logTr.className='logrow'; logTr.id='logrow_'+i;
    var logTd = document.createElement('td'); logTd.colSpan=7;
    var html = '<div class="logwrap"><div class="hint">Order log</div>';
    (o.log?.breaks||[]).forEach(function(b){
      if(b.type==='D'){
        html += '<div class="tick"><span>⏱️ Delay'+(b.cause?': '+b.cause.replace(/</g,'&lt;'):'')+'</span><span class="meta">'+b.start+' → '+b.end+' • '+b.minutes+'m</span></div>';
      } else {
        html += '<div class="tick"><span>☕ '+(b.type==='B'?'Break':'Lunch')+'</span><span class="meta">'+b.start+' → '+b.end+' • '+b.minutes+'m</span></div>';
      }
    });
    (o.log?.wraps||[]).forEach(function(w,wi){ html += '<div class="tick"><span>📦 Wrap '+(wi+1)+': <b>'+w.done+'</b> done, <b>'+w.left+'</b> left</span><span class="meta">'+w.t+'</span></div>'; });
    html += '</div>';
    logTd.innerHTML = html;
    logTr.appendChild(logTd);
    tb.appendChild(logTr);
    tr.addEventListener('click', function(){
      var row=document.getElementById('logrow_'+i);
      row.style.display = (row.style.display==='table-row') ? 'none' : 'table-row';
    });
  });
  document.getElementById('completedCard').style.display = picks.length? 'block':'none';
}

// ====== History render ======
function renderHistory(){
  var host=document.getElementById('histList'); host.innerHTML='';
  if(!historyDays.length){ host.innerHTML='<div class="hint">No archived days yet.</div>'; return; }
  var days=historyDays.slice(0).reverse();
  days.forEach(function(d,diRev){
    const di = historyDays.length - 1 - diRev; // original index
    var head=document.createElement('div'); var boxState=d.dayRate>=300?'ok':(d.dayRate>=249?'warn':'bad');
    head.className='accHead '+boxState;

    const leftDiv=document.createElement('div'); leftDiv.className='left';
    leftDiv.innerHTML = `<span class="tag">${new Date(d.date+'T12:00:00').toDateString().slice(0,15)}</span>
      <span>Units: <b>${d.totalUnits||0}</b></span>
      <span>Day Avg: <b>${d.dayRate||0}</b> u/h</span>`;
    head.appendChild(leftDiv);

    // Pro-only delete day button
    const del = document.createElement('button');
    del.textContent = '✖';
    del.className = 'btn slim ghost gate-pro';
    del.title = 'Delete day';
    del.onclick = (e)=>{ e.stopPropagation(); if(!confirm('Delete this archived day? This cannot be undone.')) return; historyDays.splice(di,1); saveAll(); renderHistory(); showToast('Day deleted'); };
    head.appendChild(del);

    const chev=document.createElement('span'); chev.className='chev'; chev.textContent='▾';
    head.appendChild(chev);

    var body=document.createElement('div'); body.className='accBody';

    // Orders table
    var table=document.createElement('table');
    table.innerHTML='<thead><tr><th>#</th><th>Customer</th><th>Units</th><th>Pallets</th><th>Start</th><th>Closed</th><th>Order Rate</th></tr></thead>';
    var tbody=document.createElement('tbody');

    (d.picks||[]).forEach(function(o,i){
      var s=hm(o.start), e=hm(o.close);
      var excl=(o.log && Array.isArray(o.log.breaks))? o.log.breaks.reduce((a,b)=>a+(b.minutes||0),0) : (o.excl||0);
      var net=(e>s)?(e-s)-(excl)/60:0.01; var rate=Math.round(o.units/Math.max(0.01,net));
      var tr=document.createElement('tr'); tr.className='clickable'; tr.dataset.idx=i;
      tr.innerHTML='<td>'+(i+1)+'</td><td>'+o.name+'</td><td>'+o.units+'</td><td>'+o.pallets+'</td><td>'+o.start+'</td><td>'+o.close+'</td><td>'+rate+' u/h</td>';
      var logTr=document.createElement('tr'); logTr.className='logrow'; logTr.id='hlog_'+di+'_'+i;
      var td=document.createElement('td'); td.colSpan=7;
      var html='<div class="logwrap"><div class="hint">Order log</div>';
      (o.log?.breaks||[]).forEach(function(b){
        if(b.type==='D'){
          html+='<div class="tick"><span>⏱️ Delay'+(b.cause?': '+b.cause.replace(/</g,'&lt;'):'')+'</span><span class="meta">'+b.start+' → '+b.end+' • '+b.minutes+'m</span></div>';
        } else {
          html+='<div class="tick"><span>☕ '+(b.type==='B'?'Break':'Lunch')+'</span><span class="meta">'+b.start+' → '+b.end+' • '+b.minutes+'m</span></div>';
        }
      });
      (o.log?.wraps||[]).forEach(function(w,wi){ html+='<div class="tick"><span>📦 Wrap '+(wi+1)+': <b>'+w.done+'</b> done, <b>'+w.left+'</b> left</span><span class="meta">'+w.t+'</span></div>'; });
      html+='</div>';
      td.innerHTML=html; logTr.appendChild(td);

      tbody.appendChild(tr); tbody.appendChild(logTr);
      tr.addEventListener('click', function(){
        var row=document.getElementById('hlog_'+di+'_'+i);
        row.style.display = (row.style.display==='table-row') ? 'none' : 'table-row';
      });
    });

    table.appendChild(tbody); body.appendChild(table);

    // Secondary expandable: Notes & Downtime
    const subAcc = document.createElement('div'); subAcc.className='accordion';
    const subHead = document.createElement('div'); subHead.className='accHead'; subHead.innerHTML='<div class="left"><span>Notes & Downtime</span></div><span class="chev">▾</span>';
    const subBody = document.createElement('div'); subBody.className='accBody';

    const notes = document.createElement('div');
    notes.className='logwrap';
    let notesHtml = '<div class="hint">Notes</div>';

    // Shift-level breaks
    (d.shiftBreaks||[]).forEach(b=>{
      notesHtml += `<div class="tick"><span>☕ ${(b.type==='B')?'Break':'Lunch'}</span><span class="meta">${b.start} → ${b.end} • ${b.minutes}m</span></div>`;
    });
    // Per-order breaks & delays
    (d.picks||[]).forEach(o=>{
      (o.log?.breaks||[]).forEach(b=>{
        if(b.type==='B' || b.type==='L'){
          notesHtml += `<div class="tick"><span>☕ ${(b.type==='B')?'Break':'Lunch'} (${o.name})</span><span class="meta">${b.start} → ${b.end} • ${b.minutes}m</span></div>`;
        } else if(b.type==='D'){
          notesHtml += `<div class="tick"><span>⏱️ Delay${b.cause?': '+b.cause.replace(/</g,'&lt;'):''} (${o.name})</span><span class="meta">${b.start} → ${b.end} • ${b.minutes}m</span></div>`;
        }
      });
    });
    // Downtimes (gaps between orders not covered by breaks)
    (d.downtimes||[]).forEach(g=>{
      notesHtml += `<div class="tick"><span>⏳ Downtime</span><span class="meta">${g.from} → ${g.to} • ${g.minutes}m</span></div>`;
    });

    notes.innerHTML = notesHtml;
    subBody.appendChild(notes);

    subAcc.appendChild(subHead);
    subAcc.appendChild(subBody);
    body.appendChild(subAcc);

    var wrap=document.createElement('div'); wrap.className='accordion'; wrap.appendChild(head); wrap.appendChild(body); host.appendChild(wrap);

    // Toggles
    head.addEventListener('click', function(){ var open=body.style.display==='block'; body.style.display=open?'none':'block'; head.querySelector('.chev').textContent=open?'▾':'▴'; });
    subHead.addEventListener('click', function(){ var open=subBody.style.display==='block'; subBody.style.display=open?'none':'block'; subHead.querySelector('.chev').textContent=open?'▾':'▴'; });
  });
  applyProGate();
}

// ====== End Shift & History mgmt ======
function updateEndShiftVisibility(){
  var btn=document.getElementById('btnEndShift');
  var trackerVisible=!document.getElementById('tabTracker').classList.contains('hidden');
  var show=trackerVisible && !current && picks.length>0;
  btn.style.display=show?'inline-block':'none';
}
function computeDowntimes(picksArr, shiftBreaksArr){
  function toMin(hhmm){ return Math.round(hm(hhmm)*60); }
  function overlap(a1,a2,b1,b2){ return Math.max(0, Math.min(a2,b2)-Math.max(a1,b1)); }
  const gaps=[];
  const sorted = picksArr.slice().sort((a,b)=>hm(a.start)-hm(b.start));
  for(let i=0;i<sorted.length-1;i++){
    const endMin = toMin(sorted[i].close);
    const nextStartMin = toMin(sorted[i+1].start);
    let gap = nextStartMin - endMin;
    if(gap>0){
      let cut=0;
      (shiftBreaksArr||[]).forEach(b=>{ cut += overlap(endMin, nextStartMin, toMin(b.start), toMin(b.end)); });
      gap = Math.max(0, gap - cut);
      if(gap>=1){ gaps.push({from: minutesToHHMM(endMin), to: minutesToHHMM(nextStartMin), minutes: gap}); }
    }
  }
  return gaps;
}
function endShift(){
  if(current){ return alert('Complete or undo the current order before ending the shift.')); }
  if(!picks.length){ return alert('No completed orders to archive.'); }
  var dateStr=todayISO();
  var shiftLen=parseFloat(document.getElementById('tLen').value||'9');
  var totalUnits=picks.reduce((a,b)=>a+b.units,0);
  var downtimes = computeDowntimes(picks, shiftBreaks);
  var snapshot={date:dateStr,start:startTime||'',end:lastClose||'',shiftLen,totalUnits,dayRate:shiftLen>0?Math.round(totalUnits/shiftLen):0,picks:picks.slice(0),shiftBreaks:shiftBreaks.slice(0),downtimes};
  historyDays.push(snapshot); saveAll(); renderHistory();

  // Reset session
  picks=[]; lastClose=''; current=null; tempWraps=[]; undoStack=[]; shiftBreaks=[];
  document.getElementById('orderArea').style.display='none';
  ['btnB','btnL','btnUndo'].forEach(id=>document.getElementById(id).style.display='none');
  document.getElementById('btnStart').style.display='inline-block';
  document.getElementById('btnStart').disabled=true;
  document.getElementById('btnComplete').style.display='none';
  document.getElementById('oLeft').value=''; document.getElementById('oTotal').value='';
  document.getElementById('completedCard').style.display='none';
  document.getElementById('shiftCard').style.display='block';
  startTime='';
  renderDone(); updateSummary(); showToast('Shift archived to History'); showTab('history'); updateEndShiftVisibility(); updateCloseEarlyVisibility(); saveAll();
}
function clearToday(){
  if(!confirm("Clear today's data (keeps History & custom customers)?")) return;
  picks=[]; current=null; tempWraps=[]; undoStack=[]; lastClose=''; startTime=''; shiftBreaks=[];
  document.getElementById('orderArea').style.display='none';
  ['btnB','btnL','btnUndo'].forEach(id=>document.getElementById(id).style.display='none');
  document.getElementById('btnStart').style.display='inline-block';
  document.getElementById('btnStart').disabled=true;
  document.getElementById('btnComplete').style.display='none';
  document.getElementById('oLeft').value=''; document.getElementById('oTotal').value='';
  document.getElementById('completedCard').style.display='none';
  document.getElementById('shiftCard').style.display='block';
  renderDone(); updateSummary(); updateDelayBtn(); updateEndShiftVisibility(); updateCloseEarlyVisibility(); saveAll();
  showToast("Today's data cleared");
}
function clearHistory(){
  if(!confirm('Clear ALL history archives? This cannot be undone.')) return;
  historyDays=[]; saveAll(); renderHistory(); showToast('History cleared');
}

// ====== Export / Import (gated) ======
function exportCSV(){
  let rows = [['#','Customer','Units','Pallets','Start','Closed','OrderRate']];
  picks.forEach((o,i)=>{
    var s=hm(o.start), e=hm(o.close);
    var excl=(o.log && Array.isArray(o.log.breaks))? o.log.breaks.reduce((a,b)=>a+(b.minutes||0),0) : (o.excl||0);
    var net=(e>s)?(e-s)-(excl)/60:0.01; var rate=Math.round(o.units/Math.max(0.01,net));
    rows.push([i+1,o.name,o.units,o.pallets,o.start,o.close,rate]);
  });
  let csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  let blob = new Blob([csv], {type:'text/csv'});
  let a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'today_picks.csv'; a.click();
}
function exportJSON(){
  let data = {version:'3.3.5', savedAt:new Date().toISOString(), history:historyDays, current, picks, startTime, lastClose, customCodes, shiftBreaks};
  let blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  let a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'wqt_export.json'; a.click();
}
(function attachImport(){
  const inp = document.getElementById('impFile');
  if(!inp) return;
  inp.addEventListener('change', function(){
    const f = inp.files && inp.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = function(){
      try {
        const obj = JSON.parse(reader.result||'{}');
        if(obj && obj.history && Array.isArray(obj.history)){
          historyDays = obj.history;
          picks = Array.isArray(obj.picks)? obj.picks: [];
          current = obj.current || null;
          startTime = obj.startTime || '';
          lastClose = obj.lastClose || '';
          if(Array.isArray(obj.customCodes)) customCodes = obj.customCodes;
          shiftBreaks = Array.isArray(obj.shiftBreaks)? obj.shiftBreaks : [];
          saveAll(); renderHistory(); renderDone(); reloadDropdowns(); updateSummary();
          showToast('Import complete');
        } else {
          alert('Invalid JSON file');
        }
      } catch(e){
        alert('Import failed: '+e.message);
      }
      inp.value = '';
    };
    reader.readAsText(f);
  });
})();

// ====== Manage Customers (gated) ======
function toggleManageCustomers(){
  var card=document.getElementById('manageCustomersCard');
  if(!card) return;
  var open = card.classList.contains('hidden');
  card.classList.toggle('hidden', !open);
  if(open) renderCustomTags();
}
function renderCustomTags(){
  var box=document.getElementById('custTags'); if(!box) return;
  box.innerHTML='';
  (customCodes||[]).forEach((code)=>{
    var tag=document.createElement('span'); tag.className='tag';
    var btn=document.createElement('button'); btn.textContent='✖'; btn.title='Remove'; btn.addEventListener('click', function(){ removeCustomCode(code); });
    tag.textContent = code+' '; tag.appendChild(btn);
    box.appendChild(tag);
  });
}
function removeCustomCode(code){
  customCodes = (customCodes||[]).filter(c=>c!==code);
  saveCustomCodes(); renderCustomTags(); reloadDropdowns(); showToast('Removed '+code);
}
function clearAllCustom(){
  if(!confirm('Remove ALL custom customers?')) return;
  customCodes=[]; saveCustomCodes(); renderCustomTags(); reloadDropdowns(); showToast('All custom customers cleared');
}

// ====== Live banner ======
function currentOrderUnitsDone(){
  if(!current) return 0;
  if(tempWraps.length===0) return 0;
  var left = tempWraps[tempWraps.length-1].left;
  return current.total - left;
}
function updateSummary(){
  var closedUnits=picks.reduce((a,b)=>a+b.units,0);
  var progress=currentOrderUnitsDone();
  var totalUnits = closedUnits + progress;
  var s=hm(startTime);
  var endHHMM = current ? nowHHMM() : lastClose;
  var e=hm(endHHMM);
  var live=(!isNaN(s)&&!isNaN(e)&&e>s)? Math.round(totalUnits/(e-s)) : 0;
  var shiftLen=parseFloat(document.getElementById('tLen').value||'9');
  var dayAvg=shiftLen>0? Math.round(totalUnits/shiftLen):0;

  var chipRate=document.getElementById('chipRate'); var chipVal=document.getElementById('chipRateVal'); chipVal.textContent=live? (live+' u/h'):'—';
  chipRate.classList.remove('good','warn','bad');
  if(live>=300) chipRate.classList.add('good');
  else if(live>=249) chipRate.classList.add('warn');
  else chipRate.classList.add('bad');

  document.getElementById('chipTotalVal').textContent=totalUnits;
  const gap = live - 300;
  document.getElementById('chipGapVal').textContent = (gap>=0?'+':'') + gap;

  updateEndShiftVisibility(); updateCloseEarlyVisibility();
}

// ====== Countback keypad logic ======
let learnedUL = {}; // {CUST:{value:count}}
function getActiveCustomerCode(){
  const sel = document.getElementById('qcCustomer');
  const other = document.getElementById('qcOther');
  let code = sel.value;
  if(code==='__OTHER__') code = upcase6(other.value||'');
  if(!code || !isValidCode(code)) return '__GEN__';
  return code;
}
function renderULayerChips(){
  const box = document.getElementById('cbChips'); if(!box) return;
  box.innerHTML='';
  const code = getActiveCustomerCode();
  const freq = learnedUL[code] || {};
  const entries = Object.entries(freq).filter(([v,c])=>c>=2).sort((a,b)=>b[1]-a[1]).slice(0,6);
  entries.forEach(([v])=>{
    const b=document.createElement('button'); b.className='btn slim'; b.type='button'; b.textContent=v+'/layer';
    b.addEventListener('click', ()=>{ cbVals.ul = String(v); updateCbDisplays(); computeCbTotal(); });
    box.appendChild(b);
  });
}
function cbSetFocus(which){
  cbFocus = which;
  document.getElementById('cbHint').textContent = (which==='layers'?'Typing Layers…':which==='ul'?'Typing U/Layer…':'Typing Extras…');
}
function cbTap(d){
  cbVals[cbFocus] = (cbVals[cbFocus]||'') + d;
  updateCbDisplays();
  computeCbTotal();
}
function cbBack(){
  const s = cbVals[cbFocus]||'';
  cbVals[cbFocus] = s.slice(0,-1);
  updateCbDisplays();
  computeCbTotal();
}
function cbReset(){
  cbVals = {layers:'', ul:'', extras:''};
  cbSetFocus('layers');
  updateCbDisplays();
  computeCbTotal();
}
function cbNextField(){
  cbFocus = (cbFocus==='layers') ? 'ul' : (cbFocus==='ul' ? 'extras' : 'extras');
  cbSetFocus(cbFocus);
}
function updateCbDisplays(){
  document.getElementById('cbLayers').textContent = cbVals.layers || '0';
  document.getElementById('cbUL').textContent     = cbVals.ul     || '0';
  document.getElementById('cbExtras').textContent = cbVals.extras || '0';
}
function computeCbTotal(){
  const L = toInt(cbVals.layers), U = toInt(cbVals.ul), E = toInt(cbVals.extras);
  const total = (L*U)+E;
  document.getElementById('cbTotal').textContent = total;
  return total;
}

// ====== QuickCalc live result ======
function recalcQuick(){
  const DEFAULT_RATE = 300;
  const units = toInt(document.getElementById('qcUnits').value);
  const rawRate = (document.getElementById('qcRate').value||'').trim();
  const rate = /^\d+$/.test(rawRate) && parseInt(rawRate,10)>0 ? parseInt(rawRate,10) : DEFAULT_RATE;

  const timeHours = rate>0 ? (units / rate) : 0;
  const totalMinutes = Math.round(timeHours*60);
  const hh = Math.floor(totalMinutes/60);
  const mm = totalMinutes % 60;

  document.getElementById('qcTime').textContent = units>0 ? (hh+'h '+String(mm).padStart(2,'0')+'m') : '—';
  document.getElementById('qcRateUsed').textContent = rate + ' u/h';
  document.getElementById('qcUnitsEcho').textContent = units || 0;
}

// ====== Boot ======
document.addEventListener('DOMContentLoaded', function(){
  try {
    loadCustomCodes();
    loadAll();

    // Build dropdowns
    buildDropdown('qcDD','qcCustomer','qcOther','qc');
    buildDropdown('oDD','oCust','oOther','o');
    reloadDropdowns();

    applyProGate();
    renderHistory(); renderDone();
    renderULayerChips();

    if(startTime){ document.getElementById('tStart').value = startTime; document.getElementById('snapHint').textContent='Start set to '+startTime; }
    if(current || picks.length>0){
      document.getElementById('shiftCard').style.display='none';
      document.getElementById('activeOrderCard').style.display = current ? 'block' : 'none';
      document.getElementById('completedCard').style.display = picks.length? 'block':'none';
      if(current){
        document.getElementById('orderArea').style.display='block';
        ['btnB','btnL','btnUndo'].forEach(id=>document.getElementById(id).style.display='inline-block');
        document.getElementById('btnStart').style.display='none';
        document.getElementById('btnComplete').style.display='inline-block';
        renderTimeline();
      } else {
        ['btnB','btnL'].forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display='inline-block'; });
      }
      showTab('tracker');
    } else {
      showTab('calc');
    }

    updateSummary(); updateDelayBtn(); updateEndShiftVisibility(); updateCloseEarlyVisibility();

    // Pro unlock & QuickCalc live
    var qcRateEl=document.getElementById('qcRate'); 
    if(qcRateEl){ 
      qcRateEl.addEventListener('input', ()=>{ updCalcGate(); recalcQuick(); }); 
      qcRateEl.addEventListener('change', ()=>{ updCalcGate(); recalcQuick(); });
    }
    var qcUnitsEl=document.getElementById('qcUnits');
    if(qcUnitsEl){ qcUnitsEl.addEventListener('input', recalcQuick); qcUnitsEl.addEventListener('change', recalcQuick); }
    // also recalc when customer changes (not strictly needed but keeps UX in sync)
    document.querySelector('#qcDD .dd-menu')?.addEventListener('click', ()=>setTimeout(recalcQuick,0));
    document.querySelector('#qcDD .dd-toggle')?.addEventListener('click', ()=>setTimeout(recalcQuick,0));

    // Start button live validation
    ['oTotal','oOther'].forEach(id=>{ const el=document.getElementById(id); el && el.addEventListener('input', refreshStartButton); });
    document.querySelector('#oDD .dd-menu')?.addEventListener('click', ()=>setTimeout(refreshStartButton,0));
    document.querySelector('#oDD .dd-toggle')?.addEventListener('click', ()=>setTimeout(refreshStartButton,0));

    setInterval(function(){
      if(!document.getElementById('tabTracker').classList.contains('hidden')) updateSummary();
    }, 600);

    var stEl=document.getElementById('tStart'); if(stEl) stEl.addEventListener('change', function(){ startTime=stEl.value; updateSummary(); saveAll(); });

    // Countback default focus
    cbSetFocus('layers'); updateCbDisplays(); computeCbTotal();

    // initial result
    recalcQuick();

  } catch (err){
    console.error(err);
    showToast('Error on load: '+(err.message||err));
  }
});
</script>
</body>
</html>
