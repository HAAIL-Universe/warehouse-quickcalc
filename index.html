<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Warehouse QuickCalc & Tracker v3.3.56</title>
<style>
:root { --bg:#0b0d10; --card:#141821; --ink:#e8eef7; --muted:#9fb3c8; --accent:#2f6bff; --line:#243244; --ok:#1b6e36; --warn:#8a6a15; --bad:#7a2b2b; }
* { box-sizing: border-box; }
html,body { margin:0; padding:0; background:#0b0d10; color:var(--ink); font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
.wrap { max-width: 980px; margin: 0 auto; padding: 14px; }
h1 { font-size: 20px; margin:6px 0 10px; }
.tabs { display:flex; gap:8px; margin:6px 0 10px; position: sticky; top:0; background:var(--bg); padding-top:6px; z-index:15; }
.tabbtn { flex:1; text-align:center; padding:10px; border:1px solid #253348; border-radius:10px; background:#0f131b; color:var(--ink); font-weight:700; cursor:pointer; }
.tabbtn.active { border-color: var(--accent); box-shadow: inset 0 0 0 1px var(--accent); }
.hidden { display:none; }
.card { background:var(--card); border:1px solid #253348; border-radius:14px; padding:14px; margin: 10px 0; }
label { display:block; font-size:12px; color:var(--muted); margin-bottom:4px; }
input, select, button, textarea { font-size:16px; }
input[type="number"], input[type="time"], input[type="text"], select, textarea {
  width:100%; background:#0f131b; color:var(--ink); border:1px solid #29364a; border-radius:10px; padding:10px; outline:none;
}
textarea{ min-height:90px; resize:vertical; }
.row { display:flex; gap:10px; flex-wrap: wrap; }
.col { flex:1; min-width:220px; }
.btn { padding:10px 12px; border-radius:10px; border:1px solid #32507a; background:#1a2a40; color:var(--ink); font-weight:700; cursor:pointer; }
.btn.ghost { background:transparent; border-color:#29364a; }
.btn.ok { border-color:#2e6b3a; background:#173220; }
.btn.warn { border-color:#8a6a15; background:#30250f; }
.btn.bad { border-color:#7a2b2b; background:#331b1b; }
.btn.chip { padding:8px 10px; border-radius:999px; }
.btn.slim { padding:6px 10px; border-radius:999px; font-size:14px; }
.btn[disabled] { opacity:0.5; cursor:not-allowed; }
.pill { border-radius:12px; padding:10px 12px; background:#0f131b; border:1px solid #29364a; text-align:center; }
.pill h3 { margin:0; font-size:13px; color:#9fb3c8; }
.pill p { margin:6px 0 0; font-size:22px; font-weight:800; }
.rateBanner { position: sticky; top:48px; z-index:10; display:flex; gap:10px; margin:8px 0; }
.rateChip { flex:1; text-align:center; padding:10px; border-radius:10px; border:1px solid #29364a; background:#0f131b; }
.rateChip.good { border-color:#1f4830; background:#14271c; }
.rateChip.warn { border-color:#584a1a; background:#2a230f; }
.rateChip.bad { border-color:#4f1f1f; background:#2a1313; }
.timeline { margin-top:8px; border-left:2px solid #29364a; padding-left:10px; }
.tick { margin:6px 0; color:#cfe2ff; font-size:13px; display:flex; align-items:center; gap:8px; justify-content:space-between; }
.tick .meta { color:#9fb3c8; font-size:12px; }
table { width:100%; border-collapse:collapse; font-size:14px; }
th, td { border-bottom:1px dashed #253348; padding:8px 6px; text-align:left; }
th { color:#9fb3c8; }
tr.clickable { cursor:pointer; }
td.small { font-size:12px; color:#9fb3c8; }
.bottom-actions { margin: 20px 0 10px; display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
.bottom-actions .left { flex:1 1 auto; min-width:220px; }
.bottom-actions .right { flex:0 0 auto; white-space:nowrap; display:flex; gap:8px; }
.safetybar { margin: 8px 0 40px; }
.safetybar .btn { width:100%; border-style:dashed; opacity:0.8; }
.hint { color:#9fb3c8; font-size:12px; }
.tagbox { display:flex; flex-wrap:wrap; gap:8px; }
.tag { display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid #29364a; background:#0f131b; font-weight:700; }
.tag button { border:0; background:transparent; color:#9fb3c8; cursor:pointer; font-size:14px; }
.accordion .accHead { width:100%; text-align:left; padding:10px; border:1px solid #29364a; background:#0f131b; border-radius:10px; display:flex; align-items:center; justify-content:space-between; gap:10px; }
.accordion .accHead.ok { border-color:#1f4830; background:#14271c; }
.accordion .accHead.warn { border-color:#584a1a; background:#2a230f; }
.accordion .accHead.bad { border-color:#4f1f1f; background:#2a1313; }
.accordion .accBody { display:none; padding:10px 0 0 0; }
.toast { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#0f131b; border:1px solid #29364a; padding:10px 12px; border-radius:10px; display:none; z-index:30; }
.toast.show { display:block; }
.logwrap { padding:8px 10px; background:#0f131b; border:1px solid #29364a; border-radius:10px; margin:8px 0; }
.logrow { display:none; }
.logrow td { border-bottom:none; padding-top:0; }
.gate-pro { display:none; }

/* Modal */
.modal { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:20; }
.modal .box { width:min(560px,92vw); background:#0f131b; border:1px solid #29364a; border-radius:12px; padding:14px; }
.modal .hdr { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
.modal .hdr h3 { margin:0; font-size:16px; color:#cfe2ff; }
.modal .fld { margin:8px 0; }
.modal .actions { display:flex; justify-content:flex-end; gap:8px; margin-top:8px; }
.count { font-variant-numeric: tabular-nums; font-weight:800; font-size:28px; }

/* Custom dropdown */
.dd { position:relative; }
.dd-toggle { width:100%; text-align:left; padding:10px; border:1px solid #29364a; border-radius:10px; background:#0f131b; color:var(--ink); cursor:pointer; }
.dd.open .dd-menu { display:block; }
.dd-menu { position:absolute; z-index:12; left:0; right:0; top:110%; background:#0f131b; border:1px solid #29364a; border-radius:10px; padding:6px; display:none; max-height:280px; overflow:auto; }
.dd-group { border:1px solid #29364a; border-radius:8px; margin:6px 0; overflow:hidden; }
.dd-group h4 { margin:0; padding:8px 10px; background:#0b0d10; color:#cfe2ff; font-size:13px; cursor:pointer; display:flex; align-items:center; justify-content:space-between; }
.dd-items { display:none; padding:4px 6px; }
.dd-items button { width:100%; text-align:left; padding:8px 10px; background:transparent; border:0; color:var(--ink); cursor:pointer; border-radius:6px; }
.dd-items button:hover { background:#11151d; }
.dd-other { margin:6px 0 0; display:flex; gap:6px; }
.dd-other button { flex:1; }
.dd-other input { flex:1; }

/* Countback calc */
.cbCard { margin-top:8px; padding:10px; border-radius:12px; border:1px dashed #29364a; background:#0f131b; }
.cbRow { display:flex; gap:8px; align-items:center; }
.cbDisplay { flex:1; display:flex; gap:8px; }
.cbBox { flex:1; border:1px solid #29364a; border-radius:10px; padding:8px; }
.cbBox h4 { margin:0 0 6px; font-size:12px; color:#9fb3c8; }
.cbVal { font-weight:800; font-size:22px; min-height:28px; }
.cbPad { display:grid; grid-template-columns:repeat(3,1fr); gap:6px; max-width:240px; }
.cbPad button { padding:12px 0; border-radius:10px; border:1px solid #32507a; background:#1a2a40; color:var(--ink); font-weight:700; }
.cbBackWide { grid-column: 2 / span 2; } /* stretch remove over the old Reset space */
.cbChips { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
.cbSummary { margin-left:auto; text-align:right; font-weight:800; }
</style>
</head>
<body>
<div class="wrap">
  <h1>Warehouse QuickCalc & Tracker v3.3.56</h1>

  <div class="tabs">
    <button id="tabCalcBtn" class="tabbtn active" type="button" onclick="showTab('calc')">QuickCalc</button>
    <button id="tabTrackBtn" class="tabbtn" type="button" onclick="showTab('tracker')">Tracker</button>
    <button id="tabHistBtn" class="tabbtn" type="button" onclick="showTab('history')">History</button>
  </div>

  <div id="liveBanner" class="rateBanner hidden">
    <div id="chipRate" class="rateChip"><b>Live Rate</b><div id="chipRateVal">—</div></div>
    <div id="chipTotal" class="rateChip"><b>Total Units</b><div id="chipTotalVal">0</div></div>
    <div id="chipGap" class="rateChip"><b>Gap vs 300</b><div id="chipGapVal">—</div></div>
  </div>

  <!-- QuickCalc -->
  <section id="tabCalc">
    <!-- Countback calculator -->
    <div class="cbCard">
      <div class="cbRow" style="flex-wrap:wrap; align-items:flex-start;">
        <div class="cbDisplay">
          <div class="cbBox">
            <h4>Layers</h4>
            <div id="cbLayers" class="cbVal">0</div>
          </div>
          <div class="cbBox">
            <h4>U/Layer</h4>
            <div id="cbUL" class="cbVal">0</div>
            <div id="cbChips" class="cbChips"></div>
          </div>
          <div class="cbBox">
            <h4>Extras</h4>
            <div id="cbExtras" class="cbVal">0</div>
          </div>
          <div class="cbSummary">
            <div class="hint">Total</div>
            <div id="cbTotal" class="count">0</div>
          </div>
        </div>
        <div style="flex:1; min-width:240px; display:flex; gap:8px;">
          <div class="cbPad" style="flex:0 0 240px;">
            <button onclick="cbTap('7')">7</button>
            <button onclick="cbTap('8')">8</button>
            <button onclick="cbTap('9')">9</button>
            <button onclick="cbTap('4')">4</button>
            <button onclick="cbTap('5')">5</button>
            <button onclick="cbTap('6')">6</button>
            <button onclick="cbTap('1')">1</button>
            <button onclick="cbTap('2')">2</button>
            <button onclick="cbTap('3')">3</button>
            <button onclick="cbTap('0')">0</button>
            <button class="cbBackWide" onclick="cbBack()">⌫</button>
          </div>
          <div style="display:flex; flex-direction:column; gap:6px; flex:1;">
            <button class="btn" onclick="cbNextField()">Next →</button>
            <button class="btn ghost" onclick="cbReset()">Reset</button>
          </div>
        </div>
      </div>
      <div class="hint" id="cbHint">(Layers × U/Layer) + Extras</div>
    </div>

    <!-- QuickCalc inputs -->
    <div class="card">
      <div class="row">
        <div class="col">
          <label>Customer</label>
          <div class="row" style="gap:6px;">
            <div class="col">
              <select id="qcCustomer" class="hidden"></select>
              <div id="qcDD" class="dd">
                <button class="dd-toggle" type="button">Select customer…</button>
                <div class="dd-menu"></div>
              </div>
            </div>
            <div class="col">
              <input id="qcOther" type="text" class="hidden" maxlength="6" placeholder="ABCDEF" pattern="[A-Za-z]{6}">
            </div>
          </div>
        </div>
        <div class="col">
          <label>Units</label>
          <input id="qcUnits" type="number" min="1" step="1" inputmode="numeric" placeholder="e.g. 820">
        </div>
        <div class="col">
          <label>Override Rate (u/h)</label>
          <input id="qcRate" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="optional">
          <div class="hint">Type <b>0000</b> to unlock Pro (Export/Import & Manage Customers) — session only.</div>
        </div>
      </div>
      <!-- Live result -->
      <div class="row" style="margin-top:10px;">
        <div class="col">
          <div class="pill">
            <h3>Time Needed</h3>
            <p id="qcTime">—</p>
          </div>
        </div>
        <div class="col">
          <div class="pill">
            <h3>Rate Used</h3>
            <p id="qcRateUsed">300 u/h</p>
          </div>
        </div>
        <div class="col">
          <div class="pill">
            <h3>Units</h3>
            <p id="qcUnitsEcho">0</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Tracker (unchanged from your last file) -->
  <!-- ... everything below stays identical to your v3.3.55; trimmed for brevity in this code cell ... -->
</div>

<script>
// ====== State ======
let picks = []; let tempWraps = []; let current = null; let startTime = ""; let lastClose = ""; let undoStack = [];
let learned = {}; let historyDays = []; let customCodes = []; let shiftBreaks = [];
let learnedUL = {};
let cbFocus = 'layers';
let cbVals = {layers:'', ul:'', extras:''};
const KEY='wqt_v2722_data', KEY_CODES='wqt_codes', KEY_LEARN='wqt_learn_ul', PRO_UNLOCK_CODE='0000';
let proUnlocked=false;
let delayDraft=null; let breakDraft=null; let breakTickId=null;

// ====== Utils ======
function showToast(msg){ try{ var t=document.getElementById('toast'); if(!t) return; t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400);}catch(e){} }
function hm(str){ if(!str) return NaN; var a=str.split(':'), H=parseInt(a[0],10), M=parseInt(a[1],10); if(isNaN(H)||isNaN(M)) return NaN; return H + M/60; }
function nowHHMM(){ var d=new Date(); return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0'); }
function todayISO(){ var d=new Date(); return d.toISOString().slice(0,10); }
function fmtMMSS(totalSec){ var s=Math.max(0,Math.round(totalSec)); var m=Math.floor(s/60), r=s%60; return String(m).padStart(2,'0')+':'+String(r).padStart(2,'0'); }
function pad2(n){return String(n).padStart(2,'0');}
function minutesToHHMM(x){ const h=Math.floor(x/60), m=x%60; return pad2(h)+':'+pad2(m); }
function toInt(s){ const n=parseInt(s||'0',10); return isNaN(n)?0:n; }

// ====== Persistence (unchanged) ======
function loadAll(){ try{ var raw=localStorage.getItem(KEY); if(raw){ var p=JSON.parse(raw);
  picks=p.picks||[]; learned=p.learned||{}; historyDays=p.history||[]; current=p.current||null; tempWraps=p.tempWraps||[];
  startTime=p.startTime||""; lastClose=p.lastClose||""; undoStack=p.undoStack||[]; proUnlocked=!!p.proUnlocked; shiftBreaks=p.shiftBreaks||[];
} var lraw=localStorage.getItem(KEY_LEARN); if(lraw){ learnedUL=JSON.parse(lraw)||{}; } }catch(e){ console.error(e); } }
function saveAll(){ try{ localStorage.setItem(KEY, JSON.stringify({version:'3.3.56', savedAt:new Date().toISOString(), picks, learned, history:historyDays, current, tempWraps, startTime, lastClose, undoStack, proUnlocked, shiftBreaks})); localStorage.setItem(KEY_LEARN, JSON.stringify(learnedUL)); }catch(e){ console.error(e); } }
setInterval(function(){ saveAll(); }, 30000);

// ====== Dropdowns / Customers (unchanged minor helpers carried over) ======
const DEFAULT_CODES=['ASDAVO','ASDERI','ASDFAL','ASDLUT','ASDWAS','BOOHAY','COOAVO','COOLEA','COOWEL','COOWES','MORNOR','MORWAK','OCAPUR','SAIEME','SAINOR','SAITHA','TESDID','TESWIN','WAILEY'];
function upcase6(s){ return (s||'').toUpperCase().replace(/[^A-Z]/g,'').slice(0,6); }
function isValidCode(s){ return /^[A-Z]{6}$/.test(s||''); }
function prefix3(code){ return (code||'').slice(0,3).toUpperCase(); }
function groupedMap(all){ const map={}; all.forEach(c=>{ const p=prefix3(c); (map[p]=map[p]||[]).push(c); }); Object.keys(map).forEach(k=>map[k].sort()); return Object.fromEntries(Object.entries(map).sort(([a],[b])=>a.localeCompare(b))); }
function loadCustomCodes(){ try{ var raw=localStorage.getItem(KEY_CODES); if(raw){ customCodes=JSON.parse(raw)||[]; } }catch(e){ customCodes=[]; } }
function saveCustomCodes(){ try{ localStorage.setItem(KEY_CODES, JSON.stringify(customCodes||[])); }catch(e){} }

function buildDropdown(ddId, selectId, otherInputId, prefix){
  const sel=document.getElementById(selectId); const dd=document.getElementById(ddId); const menu=dd.querySelector('.dd-menu'); const btn=dd.querySelector('.dd-toggle'); const otherInput=document.getElementById(otherInputId);
  function setValue(val){ sel.value=val; btn.textContent=val==='__OTHER__'?'Other…':val; onCustomerChange(prefix); if(prefix==='o') refreshStartButton(); saveAll(); dd.classList.remove('open'); }
  function render(){
    menu.innerHTML=""; const all=Array.from(new Set([...(DEFAULT_CODES||[]),...(customCodes||[])])); const groups=groupedMap(all);
    Object.keys(groups).forEach(g=>{ const wrap=document.createElement('div'); wrap.className='dd-group'; const head=document.createElement('h4'); head.innerHTML=`<span>${g}</span><span>▾</span>`; const items=document.createElement('div'); items.className='dd-items';
      head.addEventListener('click',(e)=>{ e.stopPropagation(); const open=items.style.display==='block'; items.style.display=open?'none':'block'; head.lastChild.textContent=open?'▾':'▴'; });
      groups[g].forEach(code=>{ const it=document.createElement('button'); it.type='button'; it.textContent=code; it.addEventListener('click',(e)=>{ e.stopPropagation(); setValue(code); }); items.appendChild(it); });
      wrap.appendChild(head); wrap.appendChild(items); menu.appendChild(wrap); });
    const row=document.createElement('div'); row.className='dd-other'; const otherBtn=document.createElement('button'); otherBtn.className='btn slim'; otherBtn.textContent='Other…'; otherBtn.type='button';
    otherBtn.addEventListener('click',(e)=>{ e.stopPropagation(); setValue('__OTHER__'); otherInput.classList.remove('hidden'); otherInput.focus(); }); row.appendChild(otherBtn); menu.appendChild(row);
    menu.addEventListener('click',(e)=> e.stopPropagation());
  }
  btn.addEventListener('click',(e)=>{ e.stopPropagation(); document.querySelectorAll('.dd.open').forEach(x=>{ if(x!==dd) x.classList.remove('open'); }); dd.classList.toggle('open'); if(dd.classList.contains('open')){ menu.scrollTop=0; } });
  document.addEventListener('click',(e)=>{ if(!dd.contains(e.target)) dd.classList.remove('open'); });
  render(); btn.textContent=sel.value ? (sel.value==='__OTHER__'?'Other…':sel.value) : 'Select customer…'; dd.__reload=render;
}
function reloadDropdowns(){
  const uniq=Array.from(new Set([...(DEFAULT_CODES||[]),...(customCodes||[])]));
  const qcSel=document.getElementById('qcCustomer'); const oSel=document.getElementById('oCust');
  function refill(sel){ sel.innerHTML=''; uniq.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); }); const other=document.createElement('option'); other.value='__OTHER__'; other.textContent='Other…'; sel.appendChild(other); }
  refill(qcSel); refill(oSel);
  if(document.getElementById('qcDD').__reload) document.getElementById('qcDD').__reload();
  if(document.getElementById('oDD').__reload)  document.getElementById('oDD').__reload();
}
function onCustomerChange(prefix){
  const sel=document.getElementById(prefix==='qc'?'qcCustomer':'oCust'); const input=document.getElementById(prefix==='qc'?'qcOther':'oOther');
  if(!sel || !input) return; if(sel.value==='__OTHER__'){ input.classList.remove('hidden'); input.focus(); } else { input.classList.add('hidden'); }
  if(prefix==='o') refreshStartButton(); renderULayerChips(); saveAll();
}
function onOtherInput(prefix){
  const sel=document.getElementById(prefix==='qc'?'qcCustomer':'oCust'); const input=document.getElementById(prefix==='qc'?'qcOther':'oOther'); const dd=document.getElementById(prefix==='qc'?'qcDD':'oDD');
  if(!sel || !input) return; const before=input.value; input.value=upcase6(input.value); if(before!==input.value && prefix==='o') refreshStartButton(); const code=input.value;
  if(isValidCode(code)){ if(customCodes.indexOf(code)===-1){ customCodes.push(code); saveCustomCodes(); } reloadDropdowns(); sel.value=code; input.classList.add('hidden'); if(dd && dd.querySelector('.dd-toggle')) dd.querySelector('.dd-toggle').textContent=code; if(prefix==='o') refreshStartButton(); showToast('Added '+code); renderULayerChips(); saveAll(); }
}

// ====== Pro Gate ======
function applyProGate(){ document.querySelectorAll('.gate-pro').forEach(el=> el.style.display = proUnlocked ? '' : 'none'); saveAll(); }
function updCalcGate(){ const el=document.getElementById('qcRate'); const raw=(el.value||'').toString().trim(); if(raw.replace(/\s/g,'')===PRO_UNLOCK_CODE && !proUnlocked){ proUnlocked=true; el.value=''; el.blur(); applyProGate(); showToast('Pro unlocked for this session'); recalcQuick(); } }

// ====== Tabs ======
function showTab(which){
  const id='tab'+which.charAt(0).toUpperCase()+which.slice(1);
  ['tabCalc','tabTracker','tabHistory'].forEach(x=>document.getElementById(x).classList.toggle('hidden', x!==id));
  ['tabCalcBtn','tabTrackBtn','tabHistBtn'].forEach(x=>document.getElementById(x).classList.remove('active'));
  if(which==='calc') document.getElementById('tabCalcBtn').classList.add('active');
  if(which==='tracker') document.getElementById('tabTrackBtn').classList.add('active');
  if(which==='history') document.getElementById('tabHistBtn').classList.add('active');
  if(document.getElementById('liveBanner')) document.getElementById('liveBanner').classList.toggle('hidden', which!=='tracker');
  updateDelayBtn(); updateEndShiftVisibility(); updateCloseEarlyVisibility(); saveAll();
}

// ====== Tracker core (carried from your file, no behavior changes relevant to the keypad) ======
function setNow(id){ var el=document.getElementById(id); var now=nowHHMM(); if(id==='tStart'){ el.value=now; startTime=now; var sh=document.getElementById('snapHint'); if(sh) sh.textContent='Start set to '+now; updateSummary(); } else { el.value=now; } saveAll(); }

// ... (Tracker functions unchanged to keep this snippet focused) ...

// ====== Live banner ======
function currentOrderUnitsDone(){ if(!current) return 0; if(tempWraps.length===0) return 0; var left=tempWraps[tempWraps.length-1].left; return current.total-left; }
function updateSummary(){
  var closedUnits=picks.reduce((a,b)=>a+b.units,0); var progress=currentOrderUnitsDone(); var totalUnits=closedUnits+progress;
  var s=hm(startTime); var endHHMM=current ? nowHHMM() : lastClose; var e=hm(endHHMM);
  var live=(!isNaN(s)&&!isNaN(e)&&e>s)? Math.round(totalUnits/(e-s)) : 0; var shiftLen=parseFloat(document.getElementById('tLen')?.value||'9'); var dayAvg=shiftLen>0? Math.round(totalUnits/shiftLen):0;
  var chipRate=document.getElementById('chipRate'); var chipVal=document.getElementById('chipRateVal'); if(chipVal) chipVal.textContent=live? (live+' u/h'):'—';
  if(chipRate){ chipRate.classList.remove('good','warn','bad'); if(live>=300) chipRate.classList.add('good'); else if(live>=249) chipRate.classList.add('warn'); else chipRate.classList.add('bad'); }
  var tv=document.getElementById('chipTotalVal'); if(tv) tv.textContent=totalUnits; var gap=live-300; var gv=document.getElementById('chipGapVal'); if(gv) gv.textContent=(gap>=0?'+':'')+gap;
  updateEndShiftVisibility(); updateCloseEarlyVisibility();
}

// ====== Countback keypad logic ======
const CB_MAX={layers:2, ul:2, extras:2};
function getActiveCustomerCode(){ const sel=document.getElementById('qcCustomer'); const other=document.getElementById('qcOther'); let code=sel?.value; if(code==='__OTHER__') code=upcase6(other?.value||''); if(!code || !isValidCode(code)) return '__GEN__'; return code; }
function renderULayerChips(){ const box=document.getElementById('cbChips'); if(!box) return; box.innerHTML=''; const code=getActiveCustomerCode(); const freq=learnedUL[code]||{}; const entries=Object.entries(freq).filter(([v,c])=>c>=2).sort((a,b)=>b[1]-a[1]).slice(0,6); entries.forEach(([v])=>{ const b=document.createElement('button'); b.className='btn slim'; b.type='button'; b.textContent=v+'/layer'; b.addEventListener('click',()=>{ cbVals.ul=String(v); updateCbDisplays(); computeCbTotal(); }); box.appendChild(b); }); }
function cbSetFocus(which){ cbFocus=which; var h=document.getElementById('cbHint'); if(h) h.textContent=(which==='layers'?'Typing Layers…':which==='ul'?'Typing U/Layer…':'Typing Extras…'); }
function cbTap(d){ const cap=CB_MAX[cbFocus]||2; cbVals[cbFocus]=(cbVals[cbFocus]||'')+d; if(cbVals[cbFocus].length>cap) cbVals[cbFocus]=cbVals[cbFocus].slice(0,cap); updateCbDisplays(); computeCbTotal(); if(cbVals[cbFocus].length>=cap) cbNextField(); }
function cbPrevField(){ if(cbFocus==='extras') return 'ul'; if(cbFocus==='ul') return 'layers'; return 'layers'; }
function cbBack(){
  const s=cbVals[cbFocus]||'';
  if(s.length>0){
    cbVals[cbFocus]=s.slice(0,-1);
  }else{
    // if current empty, move to previous field and delete there
    const prev = (cbFocus==='extras') ? 'ul' : (cbFocus==='ul' ? 'layers' : 'layers');
    if(prev!==cbFocus){
      cbSetFocus(prev);
      const ps=cbVals[prev]||'';
      cbVals[prev]=ps.slice(0,-1);
    }
  }
  updateCbDisplays();
  computeCbTotal();
}
function cbReset(){ cbVals={layers:'', ul:'', extras:''}; cbSetFocus('layers'); updateCbDisplays(); computeCbTotal(); }
function cbNextField(){ if(cbFocus==='layers') cbSetFocus('ul'); else if(cbFocus==='ul') cbSetFocus('extras'); else cbSetFocus('extras'); }
function updateCbDisplays(){ if(document.getElementById('cbLayers')) document.getElementById('cbLayers').textContent=cbVals.layers||'0'; if(document.getElementById('cbUL')) document.getElementById('cbUL').textContent=cbVals.ul||'0'; if(document.getElementById('cbExtras')) document.getElementById('cbExtras').textContent=cbVals.extras||'0'; }
function computeCbTotal(){ const L=toInt(cbVals.layers), U=toInt(cbVals.ul), E=toInt(cbVals.extras); const total=(L*U)+E; var t=document.getElementById('cbTotal'); if(t) t.textContent=total; return total; }

// ====== QuickCalc live result ======
function recalcQuick(){ const DEFAULT_RATE=300; const units=toInt(document.getElementById('qcUnits')?.value); const rawRate=(document.getElementById('qcRate')?.value||'').trim(); const rate=/^\d+$/.test(rawRate)&&parseInt(rawRate,10)>0?parseInt(rawRate,10):DEFAULT_RATE; const timeHours=rate>0?(units/rate):0; const totalMinutes=Math.round(timeHours*60); const hh=Math.floor(totalMinutes/60); const mm=totalMinutes%60; if(document.getElementById('qcTime')) document.getElementById('qcTime').textContent=units>0?(hh+'h '+String(mm).padStart(2,'0')+'m'):'—'; if(document.getElementById('qcRateUsed')) document.getElementById('qcRateUsed').textContent=rate+' u/h'; if(document.getElementById('qcUnitsEcho')) document.getElementById('qcUnitsEcho').textContent=units||0; }

// ====== Boot ======
document.addEventListener('DOMContentLoaded', function(){
  try{
    loadCustomCodes(); loadAll();
    // Build dropdowns
    if(document.getElementById('qcDD')){ buildDropdown('qcDD','qcCustomer','qcOther','qc'); }
    if(document.getElementById('oDD')){ buildDropdown('oDD','oCust','oOther','o'); }
    reloadDropdowns();

    document.getElementById('qcOther')?.addEventListener('input', ()=>onOtherInput('qc'));
    document.getElementById('oOther')?.addEventListener('input', ()=>onOtherInput('o'));

    applyProGate(); renderHistory?.(); renderDone?.(); renderULayerChips();

    if(startTime && document.getElementById('tStart')){ document.getElementById('tStart').value=startTime; var sh=document.getElementById('snapHint'); if(sh) sh.textContent='Start set to '+startTime; }
    updateSummary(); updateDelayBtn?.(); updateEndShiftVisibility?.(); updateCloseEarlyVisibility?.();

    var qcRateEl=document.getElementById('qcRate'); if(qcRateEl){ qcRateEl.addEventListener('input', ()=>{ updCalcGate(); recalcQuick(); }); qcRateEl.addEventListener('change', ()=>{ updCalcGate(); recalcQuick(); }); }
    var qcUnitsEl=document.getElementById('qcUnits'); if(qcUnitsEl){ qcUnitsEl.addEventListener('input', recalcQuick); qcUnitsEl.addEventListener('change', recalcQuick); }
    document.querySelector('#qcDD .dd-menu')?.addEventListener('click', ()=>setTimeout(recalcQuick,0));
    document.querySelector('#qcDD .dd-toggle')?.addEventListener('click', ()=>setTimeout(recalcQuick,0));

    // Keyboard support for keypad
    document.addEventListener('keydown', (e) => {
      const tag = (e.target && e.target.tagName) ? e.target.tagName.toUpperCase() : '';
      if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT' || tag === 'BUTTON') return;
      if (/^[0-9]$/.test(e.key)) { cbTap(e.key); e.preventDefault(); }
      else if (e.key === 'Backspace') { cbBack(); e.preventDefault(); }
      else if (e.key === ' ' || e.key === 'Enter') { cbNextField(); e.preventDefault(); }
    });

    recalcQuick();
  }catch(err){ console.error(err); showToast('Error on load: '+(err.message||err)); }
});
</script>

<!-- Minimal stubs so the page doesn't error when only using the QuickCalc tab in this demo file -->
<div id="delayModal" class="modal"><div class="box"></div></div>
<div id="breakModal" class="modal"><div class="box"></div></div>
<div id="closeEarlyModal" class="modal"><div class="box"></div></div>
<div id="toast" class="toast">Saved</div>
</body>
</html>
